
        const defaultConfig = {
            school_name: "مدرسة الطالب الذكي الخاصة بنزوى",
            welcome_text: "مرحباً بك في منصة الاختبارات التعليمية",
            instructions_title: "قواعد الاختبار",
            start_button_text: "ابدأ الاختبار",
            results_title: "نتيجة الاختبار",
            background_color: "#1e3c72",
            surface_color: "#ffffff",
            text_color: "#333333",
            primary_action_color: "#4CAF50",
            secondary_action_color: "#2196F3",
            font_family: "Cairo",
            font_size: 16
        };

        let currentConfig = { ...defaultConfig };
        let allTestData = [];

        const TEST_STATE_STORAGE_KEY = 'pirlsTestState';
        const defaultRecipient = 'kamel.fawwzia333@gmail.com';

        function createDefaultTestState() {
            return {
                subject: 'لغة عربية',
                level: '',
                duration: 0,
                studentName: '',
                gradeLevel: '',
                recipientEmail: defaultRecipient,
                questions: [],
                answers: [],
                currentQuestion: 0,
                startTime: null,
                timerInterval: null,
                scorePercentage: null,
                correctCount: 0,
                incorrectCount: 0,
                timeSpentSeconds: 0,
                remainingSeconds: null,
                isCompleted: false,
                lastVisitedPage: 'home'
            };
        }

        function loadTestState() {
            try {
                const storedState = localStorage.getItem(TEST_STATE_STORAGE_KEY);
                if (!storedState) {
                    return createDefaultTestState();
                }

                const parsedState = JSON.parse(storedState);
                const mergedState = {
                    ...createDefaultTestState(),
                    ...parsedState,
                    timerInterval: null
                };

                if (mergedState.lastVisitedPage && mergedState.lastVisitedPage.endsWith('Page')) {
                    const legacyMapping = {
                        homePage: 'home',
                        rulesPage: 'rules',
                        testPage: 'test',
                        resultsPage: 'results'
                    };
                    mergedState.lastVisitedPage = legacyMapping[mergedState.lastVisitedPage] || 'home';
                }

                return mergedState;
            } catch (error) {
                console.error('Failed to load test state:', error);
                return createDefaultTestState();
            }
        }

        function saveTestState(state) {
            try {
                const { timerInterval, ...persistable } = state;
                localStorage.setItem(TEST_STATE_STORAGE_KEY, JSON.stringify(persistable));
            } catch (error) {
                console.error('Failed to save test state:', error);
            }
        }

        function resetTestState() {
            const freshState = createDefaultTestState();
            saveTestState(freshState);
            return freshState;
        }

        const readingPassage = `ليلة لا تصدق 

    <img src="images&video/night.png" alt="ليلة لا تصدق" style="width: 50%; border-radius: 8px; margin-top: 15px;">

أَمِينَةُ فِي العَاشِرَةِ مِنْ عُمْرِهَا، وَكَانَ بِإِمْكَانِهَا أَنْ تَشُقَّ طَرِيقَهَا مِنْ غُرْفَتِهَا إِلَى الحَمَّامِ وَهِيَ نِصْفُ نَائِمَةٍ. وَيَكُونُ بَابُ غُرْفَتِهَا فِي العَادَةِ مُوَارَبًا لِيَسْمَحَ لِلْمِصْبَاحِ اللَّيْلِيِّ فِي المَمَرِّ بِأَنْ يُعْطِيَ الغُرْفَةَ إِضَاءَةً كَافِيَةً لِتَصِلَ إِلَى الحَمَّامِ مُرُورًا بِمَنْضَدَةِ الهَاتِفِ.

فِي إِحْدَى اللَّيَالِي بَيْنَمَا كَانَتْ أَمِينَةُ مَارَّةً بِمَنْضَدَةِ الهَاتِفِ فِي طَرِيقِهَا إِلَى الحَمَّامِ سَمِعَتْ صَوْتًا مُنْخَفِضًا كَالهَسِيسِ، وَلَكِنْ فِي الحَقِيقَةِ لَمْ تَهْتَمَّ لِهَذَا الصَّوْتِ كَوْنَهَا نِصْفَ نَائِمَةٍ. وَعَلَى أَيِّ حَالٍ كَانَ الصَّوْتُ قَادِمًا مِنْ بَعِيدٍ، وَلَمْ تَعْرِفْ مِنْ أَيْنَ يَأْتِي هَذَا الصَّوْتُ إِلَّا فِي طَرِيقِ عَوْدَتِهَا إِلَى غُرْفَتِهَا. كَانَتْ كُومَةٌ مِنَ الصُّحُفِ وَالمَجَلَّاتِ القَدِيمَةِ تَحْتَ المَنْضَدَةِ قَدْ بَدَأَتْ تَتَحَرَّكُ، وَمِنْ هُنَا كَانَ مَصْدَرُ الصَّوْتِ. وَفَجْأَةً بَدَأَتْ كُومَةُ الصُّحُفِ وَالمَجَلَّاتِ تَتَسَاقَطُ يَمِينًا وَشِمَالًا وَإِلَى الأَمَامِ وَالخَلْفِ. بَعْدَهَا كَانَتِ الصُّحُفُ وَالمَجَلَّاتُ فَوْقَ الأَرْضِ فِي كُلِّ مَكَانٍ. لَمْ تُصَدِّقْ أَمِينَةُ عَيْنَيْهَا حِينَ شَاهَدَتْ تِمْسَاحًا يَشْخُرُ وَيَنْخُرُ خَارِجًا مِنْ تَحْتِ المَنْضَدَةِ.

تَجَمَّدَتْ أَمِينَةُ فِي مَكَانِهَا وَاتَّسَعَتْ عَيْنَاهَا كَصَحْنَيِ فِنْجَانٍ، وَرَاقَبَتِ التِّمْسَاحَ يَزْحَفُ خَارِجًا مِنْ كُومَةِ الصُّحُفِ وَالمَجَلَّاتِ وَهُوَ يَتَلَفَّتُ فِي أَنْحَاءِ الشَّقَّةِ بِبُطْءٍ. كَانَ يَبْدُو وَكَأَنَّهُ خَارِجٌ لِتَوِّهِ مِنَ المَاءِ مُبَلَّلًا يَتَقَاطَرُ مِنْهُ المَاءُ، وَكَانَ يَتْرُكُ السَّجَّادَ مُبَلَّلًا أَيْنَمَا خَطَا.

<img src="images&video/crocodil.png" alt="ليلة لا تصدق" style="width: 50%; border-radius: 8px; margin-top: 15px;">

حَرَّكَ التِّمْسَاحُ رَأْسَهُ إِلَى الأَمَامِ وَالخَلْفِ مُصْدِرًا هَسِيسًا عَالِيًا، وَبَلَعَتْ أَمِينَةُ رِيقَهَا بِصُعُوبَةٍ وَهِيَ تَنْظُرُ إِلَى مُخَاطِ التِّمْسَاحِ وَصَفٍّ مُخِيفٍ وَطَوِيلٍ مِنَ الأَسْنَانِ، وَحَرَّكَ ذَيْلَهُ بِبُطْءٍ إِلَى الأَمَامِ وَإِلَى الخَلْفِ. كَانَتْ أَمِينَةُ قَدْ قَرَأَتْ فِي مَجَلَّةِ الحَيَوَانِ كَيْفَ يَنْفُضُ التِّمْسَاحُ المَاءَ بِذَيْلِهِ حِينَ يُطَارِدُ أَعْدَاءَهُ أَوْ يُرِيدُ الهُجُومَ عَلَيْهِمْ.

وَقَعَ نَظَرُهَا عَلَى آخِرِ عَدَدٍ مِنْ مَجَلَّةِ الحَيَوَانِ الَّذِي وَقَعَ عَلَى قَدَمِهَا مِنْ كُومَةِ الصُّحُفِ وَالمَجَلَّاتِ، ثُمَّ تَلَقَّتْ أَمِينَةُ صَدْمَةً أُخْرَى حِينَ لَاحَظَتْ أَنَّ غِلَافَ المَجَلَّةِ الَّذِي كَانَ يَحْمِلُ صُورَةَ تِمْسَاحٍ كَبِيرٍ فِي نَهْرٍ أَصْبَحَ الآنَ يَحْمِلُ صُورَةَ نَهْرٍ فَارِغٍ.

اِنْحَنَتْ أَمِينَةُ وَالْتَقَطَتِ المَجَلَّةَ، وَفِي هَذِهِ اللَّحْظَةِ حَرَّكَ التِّمْسَاحُ ذَيْلَهُ بِقُوَّةٍ حَيْثُ كَسَرَ المَزْهَرِيَّةَ عَلَى الأَرْضِ، وَنَثَرَ أَزْهَارَ دُوَّارِ الشَّمْسِ فِي كُلِّ مَكَانٍ، وَبِقَفْزَةٍ سَرِيعَةٍ كَانَتْ أَمِينَةُ فِي غُرْفَتِهَا، أَغْلَقَتِ البَابَ بِشِدَّةٍ، وَأَمْسَكَتْ بِسَرِيرِهَا وَدَفَعَتْهُ وَرَاءَ البَابِ، وَبِذَلِكَ بَنَتْ لِنَفْسِهَا مُتْرَاسًا يُبْقِيهَا فِي أَمَانٍ مِنَ التِّمْسَاحِ. ارْتَاحَتْ وَتَنَفَّسَتِ الصُّعَدَاءَ.

لَكِنَّهَا تَرَدَّدَتْ، مَاذَا لَوْ كَانَ هَذَا الوَحْشُ بِكُلِّ بَسَاطَةٍ جَائِعًا؟ رُبَّمَا عَلَيْهَا أَنْ تُعْطِيَهُ شَيْئًا لِيَأْكُلَهُ كَيْ يُغَادِرَ.

نَظَرَتْ أَمِينَةُ ثَانِيَةً إِلَى مَجَلَّةِ الحَيَوَانِ، فَإِذَا كَانَ التِّمْسَاحُ قَدِ اسْتَطَاعَ أَنْ يَزْحَفَ خَارِجَ الصُّورَةِ، فَرُبَّمَا يُمْكِنُ لِلْحَيَوَانَاتِ الأُخْرَى أَنْ تَخْرُجَ مِنَ الصُّورَةِ أَيْضًا. تَصَفَّحَتْ أَمِينَةُ المَجَلَّةَ بِسُرْعَةٍ وَتَوَقَّفَتْ عِنْدَ سَرْبٍ مِنْ طُيُورِ البَجَعِ فِي مُسْتَنْقَعٍ بِالأَدْغَالِ، وَفَكَّرَتْ أَنَّ هَذَا هُوَ الصَّوَابُ.

بَدَتْ طُيُورُ البَجَعِ وَكَأَنَّهَا كَعْكَةُ عِيدِ مِيلَادٍ لِلتِّمَاسِيحِ. وَفَجْأَةً بَدَأَ طَرَفُ ذَيْلِ التِّمْسَاحِ يَضْرِبُ شُقُوقَ البَابِ مُصْدِرًا صَوْتًا عَالِيًا.

<img src="images&video/birds.png" alt="ليلة لا تصدق" style="width: 50%; border-radius: 8px; margin-top: 15px;">

حَمَلَتْ أَمِينَةُ بِسُرْعَةٍ صُورَةَ طُيُورِ البَجَعِ إِلَى ثُقْبِ البَابِ وَصَرَخَتْ بِأَعْلَى صَوْتِهَا: «اُخْرُجِي مِنَ المُسْتَنْقَعِ!» ثُمَّ رَمَتْ بِالصُّورَةِ مِنْ خِلَالِ الثُّقْبِ إِلَى المَمَرِّ، وَأَخَذَتْ تُصَفِّقُ بِيَدَيْهَا وَتَصْرُخُ.

وَبِصُعُوبَةٍ صَدَّقَتْ أَمِينَةُ مَا حَدَثَ بَعْدَ ذَلِكَ؛ فَقَدِ امْتَلَأَ المَمَرُّ بِطُيُورِ البَجَعِ وَهِيَ تَصِيحُ وَتَرْفْرِفُ بِأَجْنِحَتِهَا وَتَرْكُضُ بِسَاقَيْهَا الدَّقِيقَتَيْنِ فِي كُلِّ مَكَانٍ. رَأَتْ أَمِينَةُ أَحَدَ الطُّيُورِ مُتَمَسِّكًا بِمِنْقَارِهِ زَهْرَةَ دُوَّارِ الشَّمْسِ، وَآخَرَ خَطَفَ قُبَّعَةَ وَالِدَتِهَا مِنْ خُطَّافِهَا، كَمَا رَأَتْ طَائِرًا يَخْتَفِي فِي فَمِ التِّمْسَاحِ، وَبِقَضْمَتَيْنِ سَرِيعَتَيْنِ ابْتَلَعَهُ. وَبِسُرْعَةٍ تَبِعَهُ الآخَرُ الَّذِي كَانَ مُمْسِكًا بِزَهْرَةِ دُوَّارِ الشَّمْسِ.

بَعْدَ وُجْبَتَيْنِ مِنْ طُيُورِ البَجَعِ اكْتَفَى التِّمْسَاحُ وَاسْتَلْقَى مُرْتَاحًا فِي وَسَطِ المَمَرِّ. وَلَمَّا أَغْمَضَ عَيْنَيْهِ وَسَكَنَ، فَتَحَتْ أَمِينَةُ بَابَهَا بِهُدُوءٍ وَخَرَجَتْ إِلَى المَمَرِّ وَوَضَعَتْ غِلَافَ المَجَلَّةِ الفَارِغَ أَمَامَ أَنْفِ التِّمْسَاحِ وَهَمَسَتْ: «رَجَاءً… رَجَاءً ارْجِعْ إِلَى بَيْتِكَ». ثُمَّ عَادَتْ إِلَى غُرْفَتِهَا وَنَظَرَتْ مِنْ ثُقْبِ البَابِ، فَرَأَتِ التِّمْسَاحَ يَعُودُ إِلَى غِلَافِ المَجَلَّةِ.

ذَهَبَتْ الآنَ بِحَذَرٍ إِلَى غُرْفَةِ المَعِيشَةِ حَيْثُ ازْدَحَمَتْ طُيُورُ البَجَعِ حَوْلَ الأَرِيكَةِ وَعَلَى التِّلْفَازِ، فَفَتَحَتْ أَمِينَةُ المَجَلَّةَ عَلَى الصَّفْحَةِ الخَالِيَةِ مِنَ الصُّورَةِ وَقَالَتْ: «شُكْرًا… شُكْرًا كَثِيرًا لَكُمْ، يُمْكِنُكُمْ العَوْدَةُ الآنَ إِلَى المُسْتَنْقَعِ».

فِي الصَّبَاحِ كَانَ مِنَ الصَّعْبِ عَلَيْهَا أَنْ تَشْرَحَ لِوَالِدَيْهَا سَبَبَ بُقْعَةِ البَلَلِ الكَبِيرَةِ عَلَى الأَرْضِ وَالبَابِ المَكْسُورِ؛ لَمْ يَكُونَا مُقْتَنِعَيْنِ بِقِصَّةِ التِّمْسَاحِ مَعَ أَنَّ قُبَّعَةَ وَالِدَتِهَا مَا زَالَتْ مَفْقُودَةً.`;

        const readingPassage2 = `قِطْعَةُ الصِّلْصَالِ الصَّغِيرَةُ
فِي أَعْلَى الطَّرِيقِ، وَفِي دَاخِلِ قَلْعَةٍ قَدِيمَةٍ، كَانَتْ هُنَالِكَ وَرْشَةٌ مُخْتَصَّةٌ فِي صِنَاعَةِ الْفَخَّارِيَّاتِ، وَكَانَتِ الْوَرْشَةُ مُكْتَظَّةً بِبَرَامِيلَ مِنَ الطِّلَاءِ الْمُلَوَّنِ، وَعَجَلَاتٍ دَوَّارَةٍ يَسْتَخْدِمُهَا صَانِعُو الْفَخَّارِيَّاتِ، وَتَنُّورٍ لِحَرْقِ الْمَصْنُوعَاتِ الْفَخَّارِيَّةِ، وَبِالطَّبْعِ الصِّلْصَالُ، وَبِالْقُرْبِ مِنَ النَّافِذَةِ كَانَ هُنَالِكَ صُنْدُوقٌ لَهُ غِطَاءٌ ثَقِيلُ الْوَزْنِ، وَكَانَ الطِّينُ يُحْفَظُ فِي ذَلِكَ الصُّنْدُوقِ. وَفِي رُكْنٍ قَصِيٍّ مِنَ الصُّنْدُوقِ كَانَتْ مَحْشُورَةً هُنَالِكَ أَقْدَمُ قِطْعَةٍ مِنَ الصِّلْصَالِ، وَبِالْكَادِ تَتَذَكَّرُ هَذِهِ الْقِطْعَةُ أَنَّ آخِرَ مَرَّةٍ اسْتُخْدِمَ فِيهَا جُزْءٌ مِنْهَا كَانَتْ قَبْلَ وَقْتٍ طَوِيلٍ، وَيُفْتَحُ غِطَاءُ الصُّنْدُوقِ الثَّقِيلِ فِي كُلِّ يَوْمٍ، وَتَمْتَدُّ أَيَادٍ لِتُمْسِكَ بِسُرْعَةٍ بِأَكْيَاسٍ أَوْ كُرَاتِ الصِّلْصَالِ، وَكَانَ بِإِمْكَانِ قِطْعَةِ الصِّلْصَالِ الصَّغِيرَةِ أَنْ تَسْمَعَ الْأَصْوَاتَ الْمَرِحَةَ لِلنَّاسِ وَهُمْ مُنْهَمِكُونَ فِي أَعْمَالِهِمْ دَاخِلَ الْوَرْشَةِ.
تَسَاءَلَتْ قِطْعَةُ الصِّلْصَالِ الصَّغِيرَةُ، مَتَى سَيَحِينُ دَوْرِي؟ وَكُلَّمَا مَرَّ يَوْمٌ بِقِطْعَةِ الصِّلْصَالِ الصَّغِيرَةِ دَاخِلَ ظَلَامِ الصُّنْدُوقِ كَانَتْ تَفْقِدُ الْأَمَلَ.
وَفِي يَوْمٍ مِنَ الْأَيَّامِ، حَضَرَتْ مَجْمُوعَةٌ كَبِيرَةٌ مِنَ الْأَطْفَالِ إِلَى الْوَرْشَةِ مَعَ مُعَلِّمِهِمْ، وَامْتَدَّتْ أَيْدٍ كَثِيرَةٌ إِلَى دَاخِلِ الصُّنْدُوقِ، وَكَانَتْ قِطْعَةُ الصِّلْصَالِ الصَّغِيرَةُ هِيَ آخِرَ مَا يُتَمُّ اخْتِيَارُهُ، إِلَّا أَنَّهَا عَلَى أَيَّةِ حَالٍ قَدْ خَرَجَتْ مِنَ الصُّنْدُوقِ.
وَقَالَتْ قِطْعَةُ الصِّلْصَالِ لِنَفْسِهَا وَهِيَ تُحَدِّقُ بِعَيْنَيْنِ نِصْفِ مُغْمَضَتَيْنِ، ٱلْآنَ جَاءَتْنِي فُرْصَتِي الْكُبْرَى...
وَقَامَ وَلَدٌ بِوَضْعِ قِطْعَةِ الصِّلْصَالِ عَلَى الْعَجَلَةِ الدَّوَّارَةِ وَبَدَأَ فِي تَدْوِيرِهَا بِأَقْصَى سُرْعَةٍ اسْتَطَاعَهَا، وَقَالَتْ قِطْعَةُ الصِّلْصَالِ لِنَفْسِهَا، إِنَّ هَذَا مُـمْتِعٌ، وَحَاوَلَ الْوَلَدُ جَذْبَ الصِّلْصَالِ إِلَى أَعْلَى أَثْنَاءَ دَوَرَانِ الْعَجَلَةِ، وَشَعَرَتْ قِطْعَةُ الصِّلْصَالِ الصَّغِيرَةُ بِالْإِثَارَةِ مِنْ حَقِيقَةِ أَنَّهَا سَتَصِيرُ شَيْئًا مَا، وَبَعْدَ أَنْ حَاوَلَ الْوَلَدُ تَشْكِيلَ وِعَاءٍ فَخَّارِيٍّ صَرَفَ النَّظَرَ عَنْ ذَلِكَ، وَقَامَ بِتَكْوِيرِ قِطْعَةِ الصِّلْصَالِ وَجَعَلَ مِنْهَا كُرَةً مَلْسَاءَ.
وَقَالَ الْمُعَلِّمُ لِلْأَطْفَالِ، حَانَ وَقْتُ التَّنْظِيفِ وَتَرْتِيبِ الْمَكَانِ، وَامْتَلَأَتِ الْوَرْشَةُ بِأَصْوَاتِ الْأَطْفَالِ وَهُمْ يَقُومُونَ بِالْمَسْحِ وَالتَّنْظِيفِ وَالْغَسْلِ وَالتَّنْشِيفِ وَٱنْتَثَرَ الْمَاءُ فِي كُلِّ مَكَانٍ.
وَرَمَى الْوَلَدُ قِطْعَةَ الصِّلْصَالِ الصَّغِيرَةَ بِالْقُرْبِ مِنَ النَّافِذَةِ وَأَسْرَعَ لِلِانْضِمَامِ إِلَى أَصْدِقَائِهِ. وَخَلَتِ الْوَرْشَةُ مِنَ الْجَمِيعِ بَعْدَ فَتْرَةٍ قَصِيرَةٍ، وَسَادَ الْهُدُوءُ وَالظَّلَامُ فِي أَرْجَاءِ الْوَرْشَةِ، وَشَعَرَتْ قِطْعَةُ الصِّلْصَالِ بِالرُّعْبِ، وَلَمْ تَفْتَقِدْ رُطُوبَةَ الصُّنْدُوقِ فَقَطْ، بَلْ تَمَلَّكَهَا إِحْسَاسٌ بِالْخَطَرِ.
وَفَكَّرَتْ قِطْعَةُ الصِّلْصَالِ الصَّغِيرَةُ وَقَالَتْ لِنَفْسِهَا، ٱنْتَهَى الْأَمْرُ.
سَأَظَلُّ جَالِسَةً هُنَا حَتَّى أَنْشَفَ وَأَصِيرَ يَابِسَةً وَصَلْبَةً كَصَخْرَةٍ.
وَظَلَّتْ قِطْعَةُ الصِّلْصَالِ قَابِعَةً بِجِوَارِ النَّافِذَةِ الْمَفْتُوحَةِ، غَيْرَ قَادِرَةٍ عَلَى الْحَرَكَةِ، وَتَشْعُرُ بِأَنَّ الرُّطُوبَةَ تَنْسَابُ خَارِجَةً مِنْهَا، وَسَقَطَتْ عَلَيْهَا أَشِعَّةُ الشَّمْسِ ثُمَّ هَبَّتْ عَلَيْهَا نَسَائِمُ اللَّيْلِ حَتَّى صَارَتْ صَلْبَةً كَأَنَّهَا صَخْرَةٌ حَتَّى كَادَتْ أَنْ تَفْقِدَ الْقُدْرَةَ عَلَى التَّفْكِيرِ، كَانَتْ فَقَطْ تَعْلَمُ أَنَّهَا مُشَبَّعَةٌ بِخَيْبَةِ الْأَمَلِ.
بَيْدَ أَنَّهُ كَانَتْ لَا تَزَالُ هُنَالِكَ فِي أَعْمَاقِ قِطْعَةِ الصِّلْصَالِ الصَّغِيرَةِ قَطْرَةٌ صَغِيرَةٌ مِنَ الرُّطُوبَةِ رَفَضَتْ أَنْ تَسْمَحَ لَهَا بِالِانْسِيَابِ خَارِجًا.
فَكَّرَتْ وَقَالَتْ لِنَفْسِهَا، مَطَرٌ.
وَتَنَهَّدَتْ مُهَمْهِمَةً، مَاءٌ.
ثُمَّ عَصَرَتْ نَفْسَهَا لِتُخْرِجَ مِنْ ذَاتِهَا الْمُحْبَطَةِ الْيَائِسَةِ قَائِلَةً، أَرْجُوكِ...
وَأَحَسَّتْ سَحَابَةٌ عَابِرَةٌ بِالرَّحْمَةِ وَالشَّفَقَةِ تُجَاهَ قِطْعَةِ الصِّلْصَالِ الصَّغِيرَةِ، وَحَدَثَ شَيْءٌ رَائِعٌ، تَسَاقَطَتْ قَطَرَاتٌ ضَخْمَةٌ عَبْرَ النَّافِذَةِ الْمَفْتُوحَةِ عَلَى قِطْعَةِ الصِّلْصَالِ الصَّغِيرَةِ، وَتَوَاصَلَ هُطُولُ الْمَطَرِ طَوَالَ اللَّيْلِ، وَعِنْدَ الصَّبَاحِ، كَانَتْ قِطْعَةُ الصِّلْصَالِ الصَّغِيرَةُ لَيِّنَةً وَطَرِيَّةً كَمَا كَانَتْ فِي الْمَاضِي.
وَقَالَتْ امْرَأَةٌ اعْتَادَتْ أَنْ تَسْتَخْدِمَ الْوَرْشَةَ فِي صِنَاعَةِ الْفَخَّارِيَّاتِ مِنْ حِينٍ لِآخَرَ لَمَّا جَاءَتْ إِلَى الْوَرْشَةِ بَعْدَ تَوَقُّفِ هُطُولِ الْمَطَرِ، أُوهْ لَا، لَقَدْ تَرَكَ أَحَدُهُمْ النَّافِذَةَ مَفْتُوحَةً طِوَالَ عُطْلَةِ نِهَايَةِ الْأُسْبُوعِ، عَلَيْنَا تَنْظِيفُ هَذِهِ الْفَوْضَى الَّتِي تَعُمُّ الْمَكَانَ. ثُمَّ قَالَتْ لِابْنَتِهَا الَّتِي كَانَتْ تُرَافِقُهَا، يُمْكِنُكِ أَنْ تَعْمَلِي بِبَعْضِ الصِّلْصَالِ أَثْنَاءَ مَا أَعْثُرُ عَلَى الْمَنَاشِفِ.
وَرَأَتِ الْبِنْتُ الصَّغِيرَةُ قِطْعَةَ الصِّلْصَالِ قَابِعَةً بِالْقُرْبِ مِنَ النَّافِذَةِ وَقَالَتْ، تَبْدُو هَذِهِ قِطْعَةً مُنَاسِبَةً جِدًّا لِي.
وَسُرْعَانَ مَا كَانَتْ تَضْغَطُ وَتَعْجِنُ قِطْعَةَ الصِّلْصَالِ الصَّغِيرَةَ وَتَصْنَعُ مِنْهَا أَشْكَالًا جَمِيلَةً، وَكَانَتْ أَصَابِعُ الْبِنْتِ تُوَلِّدُ فِي قِطْعَةِ الصِّلْصَالِ إِحْسَاسًا رَائِعًا.
وَاسْتَغْرَقَتِ الْبِنْتُ فِي التَّفْكِيرِ وَتَحَرَّكَتْ أَصَابِعُهَا لِتَصْنَعَ شَيْئًا مُحَدَّدًا مِنْ قِطْعَةِ الصِّلْصَالِ الصَّغِيرَةِ، وَشَعَرَتِ الْقِطْعَةُ بِأَنَّهَا يُتِمُّ تَشْكِيلُهَا بِلُطْفٍ وَرِقَّةٍ فِي شَكْلٍ دَائِرِيٍّ مُجَوَّفٍ لَهُ مِقْبَضٌ.
وَصَاحَتِ الْبِنْتُ، أُمِّي، أُمِّي، لَقَدْ صَنَعْتُ كُوبًا...
وَقَالَتِ الْأُمُّ رَائِعٌ، ضَعِيهِ عَلَى الرَّفِّ وَسَيَتِمُّ إِحْرَاقُهُ فِي التَّنُّورِ، وَمِنْ ثَمَّ يُمْكِنُكِ تَلْوِينُهُ بِأَيِّ لَوْنٍ تَشَائِينَ.
وَسُرْعَانَ مَا صَارَ الْكُوبُ الصَّغِيرُ جَاهِزًا لِيُؤْخَذَ إِلَى مَنْزِلِهِ الْجَدِيدِ.
وَيَعِيشُ فِي الْوَقْتِ الْحَاضِرِ عَلَى رَفِّ الْمَطْبَخِ بِجَانِبِ الْأَكْوَابِ وَالْأَقْدَاحِ وَالْكُؤُوسِ الْأُخْرَى، إِنَّهَا جَمِيعًا مُخْتَلِفَةٌ، وَبَعْضُهَا جَمِيلٌ جِدًّا...
وَنَادَتِ الْأُمُّ عَلَى ابْنَتِهَا وَهِيَ تَضَعُ الْكُوبَ الْجَدِيدَ عَلَى الْمَائِدَةِ وَهِيَ تَمْلَؤُهُ بِشَرَابِ الشُّوكُولَاتَةِ السَّاخِنِ لِلْإِفْطَارِ.
وَظَلَّتِ الْبِنْتُ مُمْسِكَةً بِالْكُوبِ الْجَدِيدِ بِرِقَّةٍ وَلُطْفٍ. كَمْ يَشْعُرُ الْكُوبُ بِالسَّعَادَةِ مِنْ خُطُوطِ شَكْلِهِ الْجَدِيدِ! مَا أَرْوَعَ أَدَاءَهُ لِوَظِيفَتِهِ!
وَشَعَرَ الْكُوبُ بِالْفَخْرِ وَالِاعْتِزَازِ وَقَالَ فِي نَفْسِهِ، أَخِيرًا - أَخِيرًا لَقَدْ صِرْتُ شَيْئًا.`;

        const questions = {
            "لغة عربية": {
                "ليلة لا تصدق": [
                    { q: "ما هي أول إشارة تبين حدوث شيء غير عادي؟ (ارجع إلى الفقرة 2)", options: ["تحرك كومة الصحف والمجلات", "رؤية أمينة لغلاف المجلة", "باب غرفتها كان مكسوراً", "سماعها لصوت كالهسيس"], correct: 3, type: "multiple_choice", level: "استنتاج" },
                    { q: "من أين جاء التمساح؟ (ارجع إلى الفقرة 3)", options: ["الحمام", "غلاف المجلة", "تحت السرير", "النهر القريب"], correct: 1, type: "multiple_choice", level: "استرجاع" },
                    { q: "أي الكلمات تبين أن أمينة كانت خائفة؟", options: ["تجمدت أمينة في مكانها", "لم تصدق عينيها", "اتسعت عيناها كصحني فنجان", "صوت منخفض كالهسيس"], correct: 0, type: "multiple_choice", level: "تفسير" },
                    { q: "لماذا فكرت أمينة أن التمساح سوف يهجم؟", options: ["أظهر صف أسنانه الطويلة", "أصدر صوتاً كالهسيس", "بدأ يشخر وينخر", "حرك ذيله إلى الأمام والخلف"], correct: 3, type: "multiple_choice", level: "استنتاج" },
                    { q: "رتب هذه الجمل حسب ترتيب حدوثها في القصة", type: "ordering", items: ["رأت أمينة التمساح", "أكل التمساح طيرين من البجع", "حاولت أمينة أن تشرح لوالديها سبب كسر الباب", "بدأت أمينة مشيها إلى الحمام", "ركضت أمينة إلى غرفتها وأغلقت الباب"], correctOrder: ["بدأت أمينة مشيها إلى الحمام", "رأت أمينة التمساح", "ركضت أمينة إلى غرفتها وأغلقت الباب", "أكل التمساح طيرين من البجع", "حاولت أمينة أن تشرح لوالديها سبب كسر الباب"], level: "دمج المعلومات" },
                    { q: "لماذا نادت أمينة طيور البجع؟ اكتب سببًا واحدًا", type: "essay", modelAnswer: "(يقبل من الطالب ما يفيد المعنى) نادت أمينة طيور البجع لأنها فكرت أن التمساح جائع ويحتاج إلى طعام ليغادر البيت، وقد قرأت في مجلة الحيوان أن طيور البجع تشبه كعكة عيد الميلاد للتماسيح، فأرادت إطعامه حتى يشبع ويعود إلى مكانه في المجلة", level: "تفسير" },
                    { q: "ما سبب كسر الباب؟ (ارجع إلى الفقرة 7)", options: ["ضرب التمساح الباب بذيله فاخترقه", "ضربته المزهرية الكبيرة", "المنقار الحاد لطائر البجع اصطدم به", "اصطدم به السرير"], correct: 0, type: "multiple_choice", level: "استرجاع" },
                    { q: "كم عمر أمينة في القصة؟ (ارجع إلى الفقرة 1)", options: ["تسع سنوات", "عشر سنوات", "إحدى عشرة سنة", "ثماني سنوات"], correct: 1, type: "multiple_choice", level: "استرجاع" },
                    { q: 'اضغط على هذا الرابط واذكر معلومة واحدة جديدة عن التمساح: <a href="https://ar.wikipedia.org/wiki/%D8%AA%D9%85%D8%B3%D8%A7%D8%AD" target="_blank">اضغط هنا</a>', type: 'essay', modelAnswer: 'تقبل من الطالب جميع الإجابات', level: 'بحث وتطبيق' },
                    { q: "اختر كل ما ينطبق على الأشياء التي حدثت عندما ظهر التمساح", options: ["تساقطت الصحف والمجلات", "كسر المزهرية", "نثر أزهار دوار الشمس", "أكل الطعام من المطبخ", "ترك السجاد مبللاً", "خطف قبعة الأم"], correct: [0, 1, 2, 4], type: "multiple_select", level: "دمج المعلومات" },
                    { q: "صل بين الشخصية والفعل", type: "matching", leftColumn: ["أمينة", "التمساح", "طيور البجع", "الوالدان"], rightColumn: ["لم يصدقا القصة", "دفعت السرير خلف الباب", "أكل طائرين", "خطفت قبعة الأم"], correctMatches: {"أمينة": "دفعت السرير خلف الباب", "التمساح": "أكل طائرين", "طيور البجع": "خطفت قبعة الأم", "الوالدان": "لم يصدقا القصة"}, level: "دمج المعلومات" },
                    { q: "رتب الأحداث حسب تسلسلها في القصة", type: "ordering", items: ["خروج طيور البجع", "اكتشاف المجلة الفارغة", "سماع صوت الهسيس", "عودة التمساح للمجلة"], correctOrder: ["سماع صوت الهسيس", "اكتشاف المجلة الفارغة", "خروج طيور البجع", "عودة التمساح للمجلة"], level: "دمج المعلومات" },
                    { q: "لماذا لم تهتم أمينة بالصوت في البداية؟", options: ["لأنها كانت خائفة", "لأنها كانت نصف نائمة", "لأنها لم تسمعه جيداً", "لأنها اعتادت على الأصوات"], correct: 1, type: "multiple_choice", level: "استنتاج" },
                    { q: "اختر جميع الأشياء التي فعلتها أمينة للحماية من التمساح", options: ["أغلقت الباب بشدة", "دفعت السرير خلف الباب", "اختبأت تحت السرير", "نادت على والديها", "بنت متراساً", "فتحت النافذة"], correct: [0, 1, 4], type: "multiple_select", level: "دمج المعلومات" },
                    { q: "ماذا لاحظت أمينة في غلاف مجلة الحيوان؟ (ارجع إلى الفقرة 5)", type: "dropdown", options: ["أصبح النهر فارغاً من التمساح", "اختفت المجلة تماماً", "تغير لون الغلاف", "ظهرت حيوانات جديدة"], correct: 0, level: "استرجاع" },
                    { q: "اسحب النقطة إلى عدد طيور البجع التي أكلها التمساح (من 1-10) - ارجع إلى الفقرة 10", type: "click_drag", range: [1, 10], correct: 2, level: "استرجاع" },
                    { q: "ما رأيك في تصرف أمينة في حل المشكلة؟ ", type: "essay", modelAnswer: " تصرفت أمينة بذكاء كبير (يقبل من الطالب ما يفيد المعنى)", level: "تقويم" },
                    { q: "ما الذي جعل أمينة تفكر في إطعام التمساح؟", options: ["نصيحة من والديها", "قراءتها في مجلة الحيوان", "اعتقادها أنه جائع", "خوفها من التمساح"], correct: 2, type: "multiple_choice", level: "استنتاج" },
                    { q: "صل بين المكان والحدث", type: "matching", leftColumn: ["تحت منضدة الهاتف", "غرفة أمينة", "الممر", "غرفة المعيشة"], rightColumn: ["عودة طيور البجع للمجلة", "بناء المتراس", "أكل التمساح للطيور", "ظهور التمساح"], correctMatches: {"تحت منضدة الهاتف": "ظهور التمساح", "غرفة أمينة": "بناء المتراس", "الممر": "أكل التمساح للطيور", "غرفة المعيشة": "عودة طيور البجع للمجلة"}, level: "دمج المعلومات" },
                    { q: "رتب هذه الأشياء حسب ظهورها في القصة", type: "ordering", items: ["قبعة الأم المفقودة", "أزهار دوار الشمس", "المزهرية المكسورة", "بقعة البلل"], correctOrder: ["أزهار دوار الشمس", "المزهرية المكسورة", "قبعة الأم المفقودة", "بقعة البلل"], level: "دمج المعلومات" },
                    { q: "كيف عرفت أمينة أن التمساح خرج من المجلة؟", options: ["رأته يخرج مباشرة", "وجدت المجلة فارغة", "أخبرها والداها", "سمعت صوت خروجه"], correct: 1, type: "multiple_choice", level: "استنتاج" },
                    { q: "اختر كل ما ينطبق على الأدلة التي تركها التمساح في البيت", options: ["بقعة البلل على الأرض", "الباب المكسور", "المزهرية المكسورة", "النوافذ المفتوحة", "قبعة الأم المفقودة", "الأثاث المقلوب"], correct: [0, 1, 2, 4], type: "multiple_select", level: "دمج المعلومات" },
                    { q: "ماذا قالت أمينة للتمساح عندما أرادت إرجاعه؟ (ارجع إلى الفقرة 11)", options: ["اذهب بعيداً", "رجاء ارجع إلى بيتك", "لا تعد مرة أخرى", "أنت مخيف جداً"], correct: 1, type: "multiple_choice", level: "استرجاع" },
                    { q: "كيف تمكنت أمينة من إخراج طيور البجع من المجلة؟ (ارجع إلى الفقرة 9)", type: "dropdown", options: ["صرخت عليها لتخرج من المستنقع", "رسمتها بنفسها", "استخدمت العصا السحرية", "طلبت المساعدة من والديها"], correct: 0, level: "استرجاع" },
                    { q: "ما شعور أمينة عندما رأت التمساح لأول مرة؟", options: ["الفرح والسعادة", "الفضول والاهتمام", "الخوف والذهول", "الغضب والانزعاج"], correct: 2, type: "multiple_choice", level: "تفسير" },
                    { q: "لماذا لم يصدق والدا أمينة قصتها؟", options: ["لأنها كانت تكذب دائماً", "لأن القصة غير منطقية", "لأنهما لم يريا التمساح", "لأنها كانت نائمة"], correct: 1, type: "multiple_choice", level: "استنتاج" },
                    { q: "ما الذي فعلته طيور البجع عندما خرجت؟ (ارجع إلى الفقرة 10)", options: ["طارت خارج البيت فوراً", "صاحت ورفرفت وركضت في كل مكان", "اختبأت تحت الأثاث", "هاجمت أمينة"], correct: 1, type: "multiple_choice", level: "استرجاع" },
                    { q: "كيف انتهت مغامرة أمينة مع التمساح؟ (ارجع إلى الفقرة 11)", options: ["هرب التمساح من النافذة", "عاد التمساح إلى المجلة", "أخذه والداها إلى حديقة الحيوان", "بقي التمساح في البيت"], correct: 1, type: "multiple_choice", level: "استرجاع" },
                    { q: "ما الدرس الرئيس من القصة؟", options: ["يجب عدم القراءة ليلاً", "التفكير الإبداعي يساعد في حل المشاكل", "المجلات خطيرة ويجب تجنبها", "الوالدان لا يصدقان الأطفال أبداً"], correct: 1, type: "multiple_choice", level: "تقويم" },
                    { q: "معنى كلمة «مواربًا» كما وردت في النص أقرب إلى:", options: ["مفتوحًا على مصراعيه", "مغلقًا بإحكام", "نصف مفتوح", "مُضاء بالكامل"], correct: 2, type: "multiple_choice", level: "تفسير" }
                ],
                "قطعة الصلصال الصغيرة": [
                    { q: "أين كانت قطعة الصلصال الصغيرة في بداية القصة؟", options: ["على العجلة الدوارة", "في ركن قصي من الصندوق", "بجانب النافذة", "في التنور"], correct: 1, type: "multiple_choice", level: "استرجاع" },
                    { q: "ماذا شعرت قطعة الصلصال وهي داخل الصندوق؟", options: ["بالفرح والسعادة", "بالخوف والرعب", "فقدت الأمل", "بالexcitement"], correct: 2, type: "multiple_choice", level: "تفسير" },
                    { q: "من الذي أخرج قطعة الصلصال من الصندوق؟", options: ["صانع الفخار", "ولد من الأطفال", "المرأة التي جاءت later", "البنت الصغيرة"], correct: 1, type: "multiple_choice", level: "استرجاع" },
                    { q: "ماذا فعل الولد بقطعة الصلصال على العجلة الدوارة؟", options: ["صنع منها كوبًا", "كورها وجعلها كرة ملساء", "تركها كما هي", "رمى بها في النافذة"], correct: 1, type: "multiple_choice", level: "استرجاع" },
                    { q: "لماذا ترك الولد قطعة الصلصال بالقرب من النافذة؟", options: ["لأنه انتهى من العمل بها", "لأن المعلم طلب منه التنظيف", "لأنه لم يعجبه شكلها", "لأنه أراد تجفيفها"], correct: 1, type: "multiple_choice", level: "استنتاج" },
                    { q: "كيف كانت حالة قطعة الصلصال بعد أن تركت بجانب النافذة؟", options: ["ظلت رطبة ولينة", "صارت صلبة كصخرة", "جفت قليلاً", "تغير لونها"], correct: 1, type: "multiple_choice", level: "استرجاع" },
                    { q: "ما الذي أنقذ قطعة الصلصال من الجفاف التام؟", options: ["الندى الصباحي", "مطر سقط من السماء", "رطوبة الجو", "أحد الأطفال سكب عليها ماء"], correct: 1, type: "multiple_choice", level: "استرجاع" },
                    { q: "من الذي وجد قطعة الصلصال بعد المطر؟", options: ["صانع الفخار", "ولد من الأطفال", "امرأة وابنتها", "المعلم"], correct: 2, type: "multiple_choice", level: "استرجاع" },
                    { q: "ماذا صنعت البنت الصغيرة من قطعة الصلصال؟", options: ["كرة", "وعاء فخاري", "كوب", "تمثال"], correct: 2, type: "multiple_choice", level: "استرجاع" },
                    { q: "أين يعيش الكوب الآن؟", options: ["في الورشة", "في المتحف", "على رف المطبخ", "عند البنت"], correct: 2, type: "multiple_choice", level: "استرجاع" },
                    { q: "كيف شعر الكوب في النهاية؟", options: ["بالحزن", "بالفخر والاعتزاز", "بالخوف", "بال indifference"], correct: 1, type: "multiple_choice", level: "تفسير" },
                    { q: "رتب هذه الأحداث حسب تسلسلها في القصة", type: "ordering", items: ["خروج قطعة الصلصال من الصندوق", "جفافها بالقرب من النافذة", "سقوط المطر عليها", "صناعة الكوب", "استخدام الكوب في المطبخ"], correctOrder: ["خروج قطعة الصلصال من الصندوق", "جفافها بالقرب من النافذة", "سقوط المطر عليها", "صناعة الكوب", "استخدام الكوب في المطبخ"], level: "دمج المعلومات" },
                    { q: "ما الدرس الرئيس من القصة؟", options: ["الصبر والتحمل", "عدم التخلي عن الأحلام", "أهمية الماء", "قيمة الأشياء الصغيرة"], correct: 0, type: "multiple_choice", level: "تقويم" },
                    { q: "لماذا كانت قطعة الصلصال تشعر باليأس؟ (اختر من القائمة)", type: "dropdown", options: ["لأنها بقيت فترة طويلة دون استخدام", "لأنها كانت خائفة من الأطفال", "لأنها لم تجف أبدًا", "لأنها تحب البقاء في الصندوق"], correct: 0, level: "تفسير" },
                    { q: "اختر كل ما يصف ورشة الفخاريات", options: ["مكتظة ببراميل الطلاء", "تحتوي على تنور", "فيها عجلات دوارة", "قريبة من النهر", "فيها صندوق للصلصال"], correct: [0, 1, 2, 4], type: "multiple_select", level: "دمج المعلومات" },
                    { q: "صل بين الشخصية والفعل", type: "matching", leftColumn: ["الولد", "البنت", "المرأة", "قطعة الصلصال"], rightColumn: ["كور الصلصال", "صنعت كوبًا", "تنظفت المكان", "شعرت بالفخر"], correctMatches: {"الولد": "كور الصلصال", "البنت": "صنعت كوبًا", "المرأة": "تنظفت المكان", "قطعة الصلصال": "شعرت بالفخر"}, level: "دمج المعلومات" },
                    // أسئلة إضافية لفقرة قطعة الصلصال الصغيرة
                    { q: "ما المادة الأساسية التي صُنعت منها القطعة؟", options: ["خشب", "صلصال", "زجاج", "ورق"], correct: 1, type: "multiple_choice", level: "استرجاع" },
                    { q: "ما الذي حدث للقطعة بعد المطر؟", options: ["ذابت", "جفت", "أصبحت لينة", "تكسرت"], correct: 2, type: "multiple_choice", level: "استنتاج" },
                    { q: "رتب مراحل صناعة الكوب", type: "ordering", items: ["تشكيل القطعة", "تجفيف القطعة", "تلوين القطعة", "حرق القطعة في التنور"], correctOrder: ["تشكيل القطعة", "تجفيف القطعة", "حرق القطعة في التنور", "تلوين القطعة"], level: "دمج المعلومات" },
                    { q: "ما الشعور الذي انتاب القطعة بعد أن أصبحت كوبًا؟", options: ["الخوف", "الفخر", "الملل", "الضياع"], correct: 1, type: "multiple_choice", level: "تفسير" },
                    { q: "اسحب النقطة إلى عمر البنت الصغيرة (من 5-12)", type: "click_drag", range: [5, 12], correct: 8, level: "استرجاع" },
                    { q: "اختر من القائمة: ما الذي جعل القطعة مفيدة؟", type: "dropdown", options: ["أنها أصبحت كوبًا", "أنها بقيت في الصندوق", "أنها لم تجف", "أنها تكسرت"], correct: 0, level: "تطبيق" },
                    { q: "ما الذي فعله الولد بالقطعة بعد التشكيل؟", options: ["تركها بجانب النافذة", "أخذها للمنزل", "أعطاها للمعلمة", "رمى بها في النهر"], correct: 0, type: "multiple_choice", level: "استرجاع" },
                    { q: "لماذا لم تجف القطعة تمامًا؟", options: ["لأن الجو كان رطبًا", "لأنها كانت في الصندوق", "لأن أحد الأطفال سكب عليها ماء", "لأنها لم تخرج للهواء"], correct: 2, type: "multiple_choice", level: "استنتاج" },
                    { q: "اسحب النقطة إلى عدد القطع التي صنعتها البنت (من 1-5)", type: "click_drag", range: [1, 5], correct: 1, level: "تطبيق" },
                    { q: "اكتب رأيك في أهمية الصبر في حياة القطعة.", type: "essay", modelAnswer: "الصبر منح القطعة فرصة لتصبح شيئًا مفيدًا وجميلاً.", level: "تقويم" },
                    { q: "ما الذي جعل القطعة تشعر بالفخر في النهاية؟", options: ["أنها أصبحت كوبًا مفيدًا", "أنها بقيت في الصندوق", "أنها لم تجف", "أنها تكسرت"], correct: 0, type: "multiple_choice", level: "تفسير" },
                    { q: "اختر من القائمة: ما المرحلة الأخيرة لصناعة الكوب؟", type: "dropdown", options: ["تشكيل القطعة", "تجفيف القطعة", "تلوين القطعة", "حرق القطعة في التنور"], correct: 2, level: "استرجاع" },
                    { q: "ما الذي حدث للقطعة عندما وُضعت بجانب النافذة؟", options: ["جفت قليلاً", "ذابت", "أصبحت صلبة جدًا", "تكسرت"], correct: 0, type: "multiple_choice", level: "استنتاج" },
                    { q: "صل بين المرحلة والوصف", type: "matching", leftColumn: ["تشكيل القطعة", "تجفيف القطعة", "تلوين القطعة", "حرق القطعة"], rightColumn: ["تصبح صلبة جدًا", "تأخذ شكلًا جديدًا", "تُضاف ألوان جميلة", "تجف من الماء"], correctMatches: {"تشكيل القطعة": "تأخذ شكلًا جديدًا", "تجفيف القطعة": "تجف من الماء", "تلوين القطعة": "تُضاف ألوان جميلة", "حرق القطعة": "تصبح صلبة جدًا"}, level: "دمج المعلومات" }
            ]
        }
    };

        let currentTest = loadTestState();

        if (!currentTest.subject) {
            currentTest.subject = 'لغة عربية';
        }

        function syncQuestionsWithCurrentLevel() {
            if (!currentTest.level) {
                currentTest.questions = [];
                return;
            }

            const subjectData = questions[currentTest.subject] || {};
            currentTest.questions = subjectData[currentTest.level] ? subjectData[currentTest.level] : [];

            updateRulesSummary();
        }

        function updateRulesSummary() {
            const levelDisplay = document.getElementById('selectedLevel');
            if (levelDisplay) {
                levelDisplay.textContent = currentTest.level || 'غير محدد';
            }

            const durationDisplay = document.getElementById('selectedDuration');
            if (durationDisplay) {
                durationDisplay.textContent = currentTest.duration === 0 ? 'بدون توقيت' : `${currentTest.duration} دقيقة`;
            }

            const totalQuestionsDisplay = document.getElementById('totalQuestions');
            if (totalQuestionsDisplay) {
                totalQuestionsDisplay.textContent = currentTest.questions.length;
            }
        }

        syncQuestionsWithCurrentLevel();

        function persistTestState() {
            saveTestState(currentTest);
        }

        function showSection(pageId) {
            let targetSection = null;

            document.querySelectorAll('.page').forEach(section => {
                if (section.dataset.page === pageId) {
                    section.classList.add('active');
                    targetSection = section;
                } else {
                    section.classList.remove('active');
                }
            });

            document.querySelectorAll('.page-container').forEach(container => {
                container.classList.remove('active-container');
            });

            if (targetSection) {
                const container = targetSection.closest('.page-container');
                if (container) {
                    container.classList.add('active-container');
                }
            }

            currentTest.lastVisitedPage = pageId;
            persistTestState();
        }

        function navigateTo(pageId) {
            if (currentTest.startTime && currentTest.duration > 0) {
                const timerDisplay = document.getElementById('timeRemaining');
                if (timerDisplay && timerDisplay.textContent.includes(':')) {
                    const [mins, secs] = timerDisplay.textContent.split(':').map(Number);
                    if (Number.isFinite(mins) && Number.isFinite(secs)) {
                        currentTest.remainingSeconds = mins * 60 + secs;
                    }
                }
            }

            if (currentTest.timerInterval && pageId !== 'test') {
                clearInterval(currentTest.timerInterval);
                currentTest.timerInterval = null;
            }

            showSection(pageId);
        }

        const allNavLinks = document.querySelectorAll('.nav-link[data-page], .nav-sublink[data-page]');

        const setActiveNav = pageId => {
            allNavLinks.forEach(link => {
                if (link.dataset.page === pageId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        };

        allNavLinks.forEach(link => {
            link.addEventListener('click', event => {
                const pageId = link.dataset.page;
                if (!pageId) {
                    return;
                }
                event.preventDefault();
                navigateTo(pageId);
                document.querySelector(pageId === 'home' ? '#homePage' : `#${pageId}Page`).scrollIntoView({ behavior: 'smooth', block: 'start' });
                setActiveNav(pageId);
                if (pageId === 'test') {
                    if (!currentTest.timerInterval && currentTest.duration > 0 && currentTest.remainingSeconds > 0) {
                        startTimer(currentTest.remainingSeconds);
                    }
                    prepareTestPage();
                }
                if (pageId === 'results') {
                    displayReview();
                }
            });
        });

        const initialPageId = currentTest.lastVisitedPage || 'home';
        showSection(initialPageId);
        setActiveNav(initialPageId);
        updateRulesSummary();

        if (initialPageId === 'test') {
            prepareTestPage();
        }

        const mainNav = document.querySelector('.main-nav');
        const navToggle = document.querySelector('.nav-toggle');
        const navLinksContainer = document.getElementById('navLinks');
        const dropdownToggles = document.querySelectorAll('.nav-dropdown-toggle');

        const closeMobileMenu = () => {
            if (navToggle && navLinksContainer) {
                navToggle.setAttribute('aria-expanded', 'false');
                navLinksContainer.classList.remove('open');
            }
        };

        const closeAllDropdowns = (exceptionId = '') => {
            dropdownToggles.forEach(toggle => {
                const controlsId = toggle.getAttribute('aria-controls');
                if (controlsId && controlsId !== exceptionId) {
                    toggle.setAttribute('aria-expanded', 'false');
                    const dropdown = document.getElementById(controlsId);
                    if (dropdown) {
                        dropdown.classList.remove('open');
                    }
                    toggle.parentElement?.classList.remove('open');
                }
            });
        };

        if (navToggle && navLinksContainer) {
            navToggle.addEventListener('click', () => {
                const expanded = navToggle.getAttribute('aria-expanded') === 'true';
                const nextState = !expanded;
                navToggle.setAttribute('aria-expanded', String(nextState));
                navLinksContainer.classList.toggle('open', nextState);
                if (!nextState) {
                    closeAllDropdowns();
                }
            });
        }

        dropdownToggles.forEach(toggle => {
            toggle.addEventListener('click', event => {
                event.preventDefault();
                const controlsId = toggle.getAttribute('aria-controls');
                if (!controlsId) {
                    return;
                }
                const expanded = toggle.getAttribute('aria-expanded') === 'true';
                const nextState = !expanded;
                closeAllDropdowns(nextState ? controlsId : '');
                toggle.setAttribute('aria-expanded', String(nextState));
                toggle.parentElement?.classList.toggle('open', nextState);
                const dropdown = document.getElementById(controlsId);
                if (dropdown) {
                    dropdown.classList.toggle('open', nextState);
                }
            });
        });

        document.addEventListener('click', event => {
            if (!mainNav) {
                return;
            }
            const target = event.target;
            if (!(target instanceof Element)) {
                return;
            }
            if (!mainNav.contains(target)) {
                closeMobileMenu();
                closeAllDropdowns();
            }
        });

        if (navLinksContainer) {
            navLinksContainer.querySelectorAll('a.nav-link, a.nav-sublink').forEach(link => {
                link.addEventListener('click', () => {
                    closeMobileMenu();
                    closeAllDropdowns();
                });
            });
        }

        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', event => {
                const targetId = anchor.getAttribute('href');
                if (!targetId || targetId === '#' || targetId.length <= 1) {
                    return;
                }
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    event.preventDefault();
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });

        // Theme Toggle Functionality
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.querySelector('.theme-icon');
        
        // Check for saved theme preference or default to light theme
        const currentTheme = localStorage.getItem('theme') || 'light';
        document.body.classList.toggle('dark-theme', currentTheme === 'dark');
        updateThemeIcon(currentTheme);
        applyThemeStyles();
        
        
        // Theme toggle event listener
        if (themeToggle) {
            themeToggle.addEventListener('click', function() {
                const isDarkTheme = document.body.classList.toggle('dark-theme');
                const newTheme = isDarkTheme ? 'dark' : 'light';

                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
                applyThemeStyles();

                document.body.classList.add('theme-transition');
                setTimeout(() => {
                    document.body.classList.remove('theme-transition');
                }, 300);
            });
        }

        function updateThemeIcon(theme) {
            if (themeIcon) {
                themeIcon.textContent = theme === 'dark' ? '☀️' : '🌙';
                themeToggle.title = theme === 'dark' ? 'تبديل إلى الوضع النهاري' : 'تبديل إلى الوضع الليلي';
            }
        }

        function applyThemeStyles() {
            const isDarkTheme = document.body.classList.contains('dark-theme');
            const bgColor = currentConfig.background_color || defaultConfig.background_color;
            const surfaceColor = currentConfig.surface_color || defaultConfig.surface_color;
            const textColor = currentConfig.text_color || defaultConfig.text_color;

            if (isDarkTheme) {
                document.body.style.removeProperty('background');
            } else {
                document.body.style.background = `linear-gradient(135deg, ${bgColor} 0%, ${adjustColor(bgColor, 20)} 100%)`;
            }

            document.querySelectorAll('.page').forEach(page => {
                if (isDarkTheme) {
                    page.style.removeProperty('background');
                    page.style.removeProperty('color');
                } else {
                    page.style.background = surfaceColor;
                    page.style.color = textColor;
                }
            });
        }

        function updateUI() {
            const schoolNameEl = document.getElementById('schoolName');
            if (schoolNameEl) {
                schoolNameEl.textContent = currentConfig.school_name || defaultConfig.school_name;
            }

            const welcomeTextEl = document.getElementById('welcomeText');
            if (welcomeTextEl) {
                welcomeTextEl.textContent = currentConfig.welcome_text || defaultConfig.welcome_text;
            }

            const instructionsTitleEl = document.getElementById('instructionsTitle');
            if (instructionsTitleEl) {
                instructionsTitleEl.textContent = currentConfig.instructions_title || defaultConfig.instructions_title;
            }

            const resultsTitleEl = document.getElementById('resultsTitle');
            if (resultsTitleEl) {
                resultsTitleEl.textContent = currentConfig.results_title || defaultConfig.results_title;
            }

            const customFont = currentConfig.font_family || defaultConfig.font_family;
            const baseSize = currentConfig.font_size || defaultConfig.font_size;
            const baseFontStack = 'sans-serif';

            document.body.style.fontFamily = `'${customFont}', ${baseFontStack}`;
            document.body.style.fontSize = `${baseSize}px`;

            const primaryColor = currentConfig.primary_action_color || defaultConfig.primary_action_color;
            const secondaryColor = currentConfig.secondary_action_color || defaultConfig.secondary_action_color;

            document.querySelectorAll('.btn').forEach(btn => {
                if (!btn.classList.contains('btn-secondary')) {
                    btn.style.background = primaryColor;
                }
            });

            document.querySelectorAll('.btn-secondary').forEach(btn => {
                btn.style.background = secondaryColor;
            });

            document.querySelectorAll('.header h1').forEach(h1 => {
                h1.style.fontSize = `${baseSize * 2.5}px`;
            });

            document.querySelectorAll('.header p').forEach(p => {
                p.style.fontSize = `${baseSize * 1.1}px`;
            });

            applyThemeStyles();
        }

        function adjustColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255))
                .toString(16).slice(1);
        }

        const studentNameInput = document.getElementById('studentName');
        if (studentNameInput) {
            studentNameInput.value = currentTest.studentName || '';
            studentNameInput.addEventListener('input', function() {
                currentTest.studentName = this.value.trim();
                persistTestState();
                checkFormComplete();
            });
        }

        const gradeLevelInput = document.getElementById('gradeLevel');
        if (gradeLevelInput) {
            gradeLevelInput.value = currentTest.gradeLevel || '';
            gradeLevelInput.addEventListener('input', function() {
                currentTest.gradeLevel = this.value.trim();
                persistTestState();
            });
        }

        currentTest.recipientEmail = defaultRecipient;

        const levelSelect = document.getElementById('levelSelect');
        if (levelSelect) {
            if (currentTest.level) {
                levelSelect.value = currentTest.level;
            }

            levelSelect.addEventListener('change', function() {
                currentTest.level = this.value;

                // عند تغيير الفقرة نعتبره اختبارًا جديدًا، فنصفر حالة الأسئلة السابقة
                currentTest.questions = [];
                currentTest.answers = [];
                currentTest.currentQuestion = 0;
                currentTest.startTime = null;
                currentTest.remainingSeconds = null;
                currentTest.scorePercentage = null;
                currentTest.correctCount = 0;
                currentTest.incorrectCount = 0;
                currentTest.timeSpentSeconds = 0;
                currentTest.isCompleted = false;

                if (currentTest.timerInterval) {
                    clearInterval(currentTest.timerInterval);
                    currentTest.timerInterval = null;
                }

                syncQuestionsWithCurrentLevel();
                persistTestState();
                checkFormComplete();
            });
        }

        const durationSelect = document.getElementById('durationSelect');
        if (durationSelect) {
            durationSelect.value = currentTest.duration ? String(currentTest.duration) : '0';
            durationSelect.addEventListener('change', function() {
                currentTest.duration = parseInt(this.value, 10);
                persistTestState();
                updateRulesSummary();
            });
        }

        const continueBtn = document.getElementById('continueBtn');

        function checkFormComplete() {
            const name = currentTest.studentName;
            const level = currentTest.level;

            if (continueBtn) {
                continueBtn.disabled = !(name && level);
            }
        }

        checkFormComplete();

        if (continueBtn) {
            continueBtn.addEventListener('click', function() {
                if (!currentTest.studentName && studentNameInput) {
                    currentTest.studentName = studentNameInput.value.trim();
                }

                if (gradeLevelInput && gradeLevelInput.value) {
                    currentTest.gradeLevel = gradeLevelInput.value.trim();
                }

                if (!currentTest.level) {
                    return;
                }

                syncQuestionsWithCurrentLevel();
                persistTestState();
                navigateTo('rules');
            });
        }

        const backBtn = document.getElementById('backToHomeBtn');
        if (backBtn) {
            backBtn.addEventListener('click', function() {
                navigateTo('home');
            });
        }

        const startBtn = document.getElementById('startTestBtn');
        if (startBtn) {
            startBtn.addEventListener('click', function() {
                currentTest.answers = new Array(currentTest.questions.length).fill(null);
                currentTest.currentQuestion = 0;
                currentTest.startTime = Date.now();
                currentTest.remainingSeconds = currentTest.duration > 0 ? currentTest.duration * 60 : 0;
                persistTestState();
                navigateTo('test');
                prepareTestPage();
            });
        }

        function prepareTestPage() {
            const showTextBtn = document.getElementById('showTextBtn');
            if (showTextBtn && !showTextBtn.dataset.bound) {
                showTextBtn.addEventListener('click', function() {
                    const readingDiv = document.getElementById('readingPassage');
                    if (readingDiv) {
                        readingDiv.style.display = readingDiv.style.display === 'none' ? 'block' : 'none';
                        this.textContent = readingDiv.style.display === 'none' ? 'عرض النص' : 'إخفاء النص';
                    }
                });
                showTextBtn.dataset.bound = 'true';
            }

            if (!currentTest.level) {
                navigateTo('rules');
                return;
            }

            if (currentTest.questions.length === 0) {
                syncQuestionsWithCurrentLevel();
                if (currentTest.questions.length === 0) {
                    navigateTo('rules');
                    return;
                }
            }

            if (currentTest.startTime && !currentTest.timerInterval && currentTest.duration > 0) {
                const timeLeft = currentTest.remainingSeconds && currentTest.remainingSeconds > 0
                    ? currentTest.remainingSeconds
                    : undefined;
                startTimer(timeLeft);
            }

            displayQuestion();
        }

        function startTimer(initialTimeLeft) {
            if (currentTest.timerInterval) {
                clearInterval(currentTest.timerInterval);
            }

            let timeLeft = typeof initialTimeLeft === 'number' ? initialTimeLeft : currentTest.duration * 60;
            if (!Number.isFinite(timeLeft)) {
                return;
            }

            const timerDisplay = document.getElementById('timeRemaining');
            const updateDisplay = (seconds) => {
                if (!timerDisplay) return;
                const minutes = Math.max(0, Math.floor(seconds / 60));
                const secs = Math.max(0, seconds % 60);
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            if (timeLeft <= 0) {
                updateDisplay(0);
                finishTest();
                return;
            }

            updateDisplay(timeLeft);

            currentTest.timerInterval = setInterval(function() {
                timeLeft--;

                updateDisplay(timeLeft);

                if (timeLeft <= 0) {
                    clearInterval(currentTest.timerInterval);
                    currentTest.timerInterval = null;
                    finishTest();
                }
            }, 1000);
        }

        function displayQuestion() {
            const q = currentTest.questions[currentTest.currentQuestion];
            const total = currentTest.questions.length;

            document.getElementById('currentQuestion').textContent = currentTest.currentQuestion + 1;
            document.getElementById('totalQuestionsTest').textContent = total;
            const questionNumberEl = document.getElementById('questionNumber');
            questionNumberEl.textContent = `السؤال ${currentTest.currentQuestion + 1}`;

            const existingBadge = questionNumberEl.querySelector('.question-level-badge');
            if (existingBadge) {
                existingBadge.remove();
            }

            // إضافة مستوى الفهم
            if (q.level) {
                const levelBadge = document.createElement('div');
                levelBadge.className = 'question-level-badge';
                levelBadge.style.cssText = `
                    display: inline-block;
                    background: #e3f2fd;
                    color: #1565c0;
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 0.85em;
                    font-weight: 600;
                    margin-right: 10px;
                    border: 1px solid #bbdefb;
                `;
                levelBadge.textContent = `مستوى: ${q.level}`;
                questionNumberEl.appendChild(levelBadge);
            }
            
            const questionHeader = document.querySelector('.question-header');
            const showTextBtn = document.getElementById('showTextBtn');
            const shouldShowReading = currentTest.level === 'ليلة لا تصدق' || currentTest.level === 'قطعة الصلصال الصغيرة';
            let readingDiv = document.getElementById('readingPassage');

            if (shouldShowReading && questionHeader) {
                if (!readingDiv) {
                    readingDiv = document.createElement('div');
                    readingDiv.id = 'readingPassage';
                    readingDiv.style.cssText = `
                        background: #f8f9fa;
                        padding: 25px;
                        border-radius: 8px;
                        margin: 20px 0;
                        border-right: 4px solid #4CAF50;
                        line-height: 1.8;
                        font-size: 1.6em;
                        color: #000000;
                        max-height: 400px;
                        overflow-y: auto;
                    `;

                    questionHeader.parentElement?.insertBefore(readingDiv, questionHeader);
                }

                const selectedPassage = currentTest.level === 'ليلة لا تصدق' ? readingPassage : readingPassage2;
                readingDiv.innerHTML = `
                    <h3 style="color: #000000; margin-top: 0; margin-bottom: 15px; font-size: 1.25em;">اقرأ النص التالي، ثم أجب على الأسئلة التي تليه :</h3>
                    <div style="white-space: pre-line;">${selectedPassage}</div>
                `;
                readingDiv.style.display = 'block';

                if (showTextBtn) {
                    showTextBtn.style.display = 'inline-flex';
                    showTextBtn.textContent = 'إخفاء النص';
                    showTextBtn.setAttribute('aria-expanded', 'true');
                }
            } else {
                if (readingDiv) {
                    readingDiv.remove();
                }

                if (showTextBtn) {
                    showTextBtn.style.display = 'none';
                    showTextBtn.textContent = 'عرض النص';
                    showTextBtn.removeAttribute('aria-expanded');
                }
            }
            
            document.getElementById('questionText').innerHTML = q.q;

            const progress = ((currentTest.currentQuestion + 1) / total) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';

            const questionType = q.type || 'multiple_choice';

            if (questionType === 'multiple_choice') {
                displayMultipleChoice(q, optionsContainer);
            } else if (questionType === 'drag_drop') {
                displayDragDrop(q, optionsContainer);
            } else if (questionType === 'dropdown') {
                displayDropdown(q, optionsContainer);
            } else if (questionType === 'click_drag') {
                displayClickDrag(q, optionsContainer);
            } else if (questionType === 'essay') {
                displayEssay(q, optionsContainer);
            } else if (questionType === 'matching') {
                displayMatching(q, optionsContainer);
            } else if (questionType === 'ordering') {
                displayOrdering(q, optionsContainer);
            } else if (questionType === 'multiple_select') {
                displayMultipleSelect(q, optionsContainer);
            }

            document.getElementById('prevBtn').disabled = currentTest.currentQuestion === 0;

            if (currentTest.currentQuestion === total - 1) {
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('finishBtn').style.display = 'inline-block';
            } else {
                document.getElementById('nextBtn').style.display = 'inline-block';
                document.getElementById('finishBtn').style.display = 'none';
            }

            if (!shouldShowReading && showTextBtn) {
                showTextBtn.style.display = 'none';
            }
        }

        function displayMultipleChoice(q, container) {
            q.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = option;

                if (currentTest.answers[currentTest.currentQuestion] === index) {
                    optionDiv.classList.add('selected');
                }

                optionDiv.addEventListener('click', function() {
                    document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    currentTest.answers[currentTest.currentQuestion] = index;
                    showAnswerNote();
                });

                container.appendChild(optionDiv);
            });
        }

        function displayDragDrop(q, container) {
            const dragDropDiv = document.createElement('div');
            dragDropDiv.className = 'drag-drop-container';

            const instruction = document.createElement('p');
            instruction.textContent = 'اسحب العناصر وأفلتها في المنطقة أدناه بالترتيب الصحيح';
            instruction.style.marginBottom = '15px';
            instruction.style.fontWeight = '600';
            dragDropDiv.appendChild(instruction);

            const dragItems = document.createElement('div');
            dragItems.className = 'drag-items';

            const savedAnswer = currentTest.answers[currentTest.currentQuestion];
            const itemsToShow = savedAnswer && Array.isArray(savedAnswer) ? q.items : q.items.slice().sort(() => Math.random() - 0.5);

            itemsToShow.forEach((item, index) => {
                const dragItem = document.createElement('div');
                dragItem.className = 'drag-item';
                dragItem.textContent = item;
                dragItem.draggable = true;
                dragItem.dataset.item = item;

                dragItem.addEventListener('dragstart', function(e) {
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', item);
                });

                dragItem.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });

                dragItems.appendChild(dragItem);
            });

            const dropZone = document.createElement('div');
            dropZone.className = 'drop-zone';
            dropZone.id = 'dropZone';

            if (savedAnswer && Array.isArray(savedAnswer)) {
                savedAnswer.forEach(item => {
                    const dragItem = document.createElement('div');
                    dragItem.className = 'drag-item';
                    dragItem.textContent = item;
                    dragItem.draggable = true;
                    dragItem.dataset.item = item;

                    dragItem.addEventListener('dragstart', function(e) {
                        this.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', item);
                    });

                    dragItem.addEventListener('dragend', function() {
                        this.classList.remove('dragging');
                    });

                    dropZone.appendChild(dragItem);
                });
                dragItems.innerHTML = '';
            }

            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');

                const item = e.dataTransfer.getData('text/plain');
                const draggingElement = document.querySelector('.dragging');

                if (draggingElement) {
                    this.appendChild(draggingElement);
                    updateDragDropAnswer();
                }
            });

            dragItems.addEventListener('dragover', function(e) {
                e.preventDefault();
            });

            dragItems.addEventListener('drop', function(e) {
                e.preventDefault();
                const draggingElement = document.querySelector('.dragging');
                if (draggingElement && draggingElement.parentElement.id === 'dropZone') {
                    this.appendChild(draggingElement);
                    updateDragDropAnswer();
                }
            });

            function updateDragDropAnswer() {
                const droppedItems = Array.from(dropZone.children).map(el => el.dataset.item);
                currentTest.answers[currentTest.currentQuestion] = droppedItems;
                if (droppedItems.length > 0) {
                    showAnswerNote();
                }
            }

            dragDropDiv.appendChild(dragItems);
            dragDropDiv.appendChild(dropZone);
            container.appendChild(dragDropDiv);
        }

        function displayDropdown(q, container) {
            const dropdownDiv = document.createElement('div');
            dropdownDiv.className = 'dropdown-container';

            const select = document.createElement('select');
            select.className = 'dropdown-select';
            select.id = 'dropdownSelect';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'اختر الإجابة الصحيحة';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            select.appendChild(defaultOption);

            q.options.forEach((option, index) => {
                const optionElement = document.createElement('option');
                optionElement.value = index;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });

            const savedAnswer = currentTest.answers[currentTest.currentQuestion];
            if (savedAnswer !== null && savedAnswer !== undefined) {
                select.value = savedAnswer;
                select.classList.add('answered');
            }

            select.addEventListener('change', function() {
                currentTest.answers[currentTest.currentQuestion] = parseInt(this.value);
                this.classList.add('answered');
                showAnswerNote();
            });

            dropdownDiv.appendChild(select);
            container.appendChild(dropdownDiv);
        }

        function displayClickDrag(q, container) {
            const clickDragDiv = document.createElement('div');
            clickDragDiv.className = 'click-drag-container';

            const sliderContainer = document.createElement('div');
            sliderContainer.className = 'slider-container';

            const instruction = document.createElement('p');
            instruction.textContent = 'اسحب المؤشر لاختيار الإجابة الصحيحة';
            instruction.style.marginBottom = '20px';
            instruction.style.fontWeight = '600';

            const slider = document.createElement('input');
            slider.type = 'range';
            slider.className = 'slider';
            slider.min = q.range[0];
            slider.max = q.range[1];
            slider.value = q.range[0];
            slider.id = 'clickDragSlider';

            const valueDisplay = document.createElement('div');
            valueDisplay.className = 'slider-value';
            valueDisplay.textContent = `القيمة المختارة: ${slider.value}`;

            const labels = document.createElement('div');
            labels.className = 'slider-labels';
            labels.innerHTML = `<span>${q.range[0]}</span><span>${q.range[1]}</span>`;

            const savedAnswer = currentTest.answers[currentTest.currentQuestion];
            if (savedAnswer !== null && savedAnswer !== undefined) {
                slider.value = savedAnswer;
                valueDisplay.textContent = `القيمة المختارة: ${savedAnswer}`;
            }

            slider.addEventListener('input', function() {
                valueDisplay.textContent = `القيمة المختارة: ${this.value}`;
                currentTest.answers[currentTest.currentQuestion] = parseInt(this.value);
                showAnswerNote();
            });

            sliderContainer.appendChild(instruction);
            sliderContainer.appendChild(valueDisplay);
            sliderContainer.appendChild(slider);
            sliderContainer.appendChild(labels);
            clickDragDiv.appendChild(sliderContainer);
            container.appendChild(clickDragDiv);
        }

        function displayEssay(q, container) {
            const essayDiv = document.createElement('div');
            essayDiv.className = 'essay-container';

            const instructions = document.createElement('div');
            instructions.className = 'essay-instructions';
            instructions.innerHTML = `
                <strong>تعليمات:</strong><br>
                • اكتب إجابتك بوضوح ودقة<br>
                • لا يوجد حد أدنى أو أقصى لعدد الكلمات<br>
                • ركز على المحتوى والمعنى
            `;

            const textarea = document.createElement('textarea');
            textarea.className = 'essay-textarea';
            textarea.placeholder = 'اكتب إجابتك هنا...';
            textarea.id = 'essayTextarea';

            const wordCount = document.createElement('div');
            wordCount.className = 'word-count';
            wordCount.textContent = 'عدد الكلمات: 0';

            const savedAnswer = currentTest.answers[currentTest.currentQuestion];
            if (savedAnswer && typeof savedAnswer === 'string') {
                textarea.value = savedAnswer;
                textarea.classList.add('answered');
                updateWordCount();
            }

            function updateWordCount() {
                const text = textarea.value.trim();
                const words = text ? text.split(/\s+/).length : 0;
                wordCount.textContent = `عدد الكلمات: ${words}`;
                wordCount.className = 'word-count valid';
            }

            textarea.addEventListener('input', function() {
                currentTest.answers[currentTest.currentQuestion] = this.value;
                updateWordCount();
                
                if (this.value.trim()) {
                    this.classList.add('answered');
                    showAnswerNote();
                } else {
                    this.classList.remove('answered');
                }
            });

            essayDiv.appendChild(instructions);
            essayDiv.appendChild(textarea);
            essayDiv.appendChild(wordCount);
            container.appendChild(essayDiv);
        }

        function displayMatching(q, container) {
            const matchingDiv = document.createElement('div');
            matchingDiv.className = 'matching-container';

            const instruction = document.createElement('p');
            instruction.textContent = 'انقر على عنصر من العمود الأيسر ثم على العنصر المطابق له من العمود الأيمن';
            instruction.style.marginBottom = '20px';
            instruction.style.fontWeight = '600';
            instruction.style.textAlign = 'center';

            const columnsDiv = document.createElement('div');
            columnsDiv.className = 'matching-columns';
            columnsDiv.style.position = 'relative';

            const leftColumn = document.createElement('div');
            leftColumn.className = 'matching-column';
            leftColumn.innerHTML = '<h4>العمود الأول</h4>';

            const rightColumn = document.createElement('div');
            rightColumn.className = 'matching-column';
            rightColumn.innerHTML = '<h4>العمود الثاني</h4>';

            let selectedLeft = null;
            let matches = {};
            const savedAnswer = currentTest.answers[currentTest.currentQuestion];
            if (savedAnswer && typeof savedAnswer === 'object') {
                matches = { ...savedAnswer };
            }

            const colorListLight = [
    '#b2e0ff', '#ffe6b3', '#d1ffd6', '#ffd6e0', '#e6d6ff', '#fff7b2', '#b2fff7', '#ffb2e0', '#c6ffb2', '#b2d6ff', '#ffd6b2', '#b2ffd6', '#ffb2b2', '#e0b2ff', '#b2ffe0', '#b2b2ff'
];
const colorListDark = [
    '#2e4252', '#665c2e', '#2e523e', '#522e3a', '#3a2e52', '#52492e', '#2e5249', '#522e4a', '#3a522e', '#2e3a52', '#52422e', '#2e5242', '#522e2e', '#4a2e52', '#2e524a', '#2e2e52'
];
function getThemeColorList() {
    const body = document.body;
    if (body.classList.contains('dark-mode') || body.classList.contains('dark-theme')) {
        return colorListDark;
    }
    return colorListLight;
}
let colorList = getThemeColorList();
// تحديث القائمة عند تغيير الوضع الليلي/النهاري تلقائيًا
const observer = new MutationObserver(() => {
    colorList = getThemeColorList();
});
observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
const pairColors = {};
let colorIdx = 0;

q.leftColumn.forEach((item, index) => {
    const leftItem = document.createElement('div');
    leftItem.className = 'matching-item';
    leftItem.textContent = item;
    leftItem.dataset.item = item;
    leftItem.dataset.side = 'left';

    // إذا كان متصل، أعطه لون خاص
    if (matches[item]) {
        if (!pairColors[item]) {
            pairColors[item] = colorList[colorIdx % colorList.length];
            colorIdx++;
        }
        leftItem.style.background = pairColors[item];
        leftItem.classList.add('matched');
        // زر إلغاء التوصيلة
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = '✖';
        cancelBtn.title = 'إلغاء التوصيلة';
        cancelBtn.className = 'matching-cancel-btn';
        cancelBtn.onclick = function(e) {
            e.stopPropagation();
            const matchedRight = matches[item];
            delete matches[item];
            currentTest.answers[currentTest.currentQuestion] = { ...matches };
            leftItem.classList.remove('matched');
            leftItem.style.background = '';
            const rightEl = rightColumn.querySelector(`[data-item="${matchedRight}"]`);
            if (rightEl) {
                rightEl.classList.remove('matched');
                rightEl.style.background = '';
                const btn = rightEl.querySelector('.matching-cancel-btn');
                if (btn) rightEl.removeChild(btn);
            }
            if (leftItem.querySelector('.matching-cancel-btn')) leftItem.removeChild(cancelBtn);
        };
        leftItem.appendChild(cancelBtn);
    }

    leftItem.addEventListener('click', function() {
        // إذا كان العنصر متصل بالفعل، إبراز التوصيلة ولا يتم فكها مباشرة
        if (matches[item]) {
            document.querySelectorAll('.matching-item').forEach(el => el.classList.remove('matching-highlight'));
            this.classList.add('matching-highlight');
            const matchedRight = matches[item];
            const rightEl = rightColumn.querySelector(`[data-item="${matchedRight}"]`);
            if (rightEl) rightEl.classList.add('matching-highlight');
            setTimeout(() => {
                this.classList.remove('matching-highlight');
                if (rightEl) rightEl.classList.remove('matching-highlight');
            }, 900);
            return;
        }
        document.querySelectorAll('.matching-item[data-side="left"]').forEach(el => {
            el.classList.remove('selected');
        });
        this.classList.add('selected');
        selectedLeft = item;
    });

    leftColumn.appendChild(leftItem);
});

            q.rightColumn.forEach((item, index) => {
    const rightItem = document.createElement('div');
    rightItem.className = 'matching-item';
    rightItem.textContent = item;
    rightItem.dataset.item = item;
    rightItem.dataset.side = 'right';

    // إذا كان مرتبط، لونه كلون التوصيلة
    const leftKey = Object.keys(matches).find(key => matches[key] === item);
    if (leftKey) {
        if (!pairColors[leftKey]) {
            pairColors[leftKey] = colorList[colorIdx % colorList.length];
            colorIdx++;
        }
        rightItem.style.background = pairColors[leftKey];
        rightItem.classList.add('matched');
        // زر إلغاء التوصيلة
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = '✖';
        cancelBtn.title = 'إلغاء التوصيلة';
        cancelBtn.className = 'matching-cancel-btn';
        cancelBtn.onclick = function(e) {
            e.stopPropagation();
            delete matches[leftKey];
            currentTest.answers[currentTest.currentQuestion] = { ...matches };
            rightItem.classList.remove('matched');
            rightItem.style.background = '';
            const leftEl = leftColumn.querySelector(`[data-item="${leftKey}"]`);
            if (leftEl) {
                leftEl.classList.remove('matched');
                leftEl.style.background = '';
                const btn = leftEl.querySelector('.matching-cancel-btn');
                if (btn) leftEl.removeChild(btn);
            }
            if (rightItem.querySelector('.matching-cancel-btn')) rightItem.removeChild(cancelBtn);
        };
        rightItem.appendChild(cancelBtn);
    }

    rightItem.addEventListener('click', function() {
        // إذا كان متصل، إبراز التوصيلة
        if (leftKey) {
            document.querySelectorAll('.matching-item').forEach(el => el.classList.remove('matching-highlight'));
            this.classList.add('matching-highlight');
            const leftEl = leftColumn.querySelector(`[data-item="${leftKey}"]`);
            if (leftEl) leftEl.classList.add('matching-highlight');
            setTimeout(() => {
                this.classList.remove('matching-highlight');
                if (leftEl) leftEl.classList.remove('matching-highlight');
            }, 900);
            return;
        }
        if (!selectedLeft) return;
        // إذا كان هذا العنصر متصل بالفعل مع عنصر آخر من اليسار، فك التوصيلة القديمة
        const alreadyMatchedLeft = Object.keys(matches).find(key => matches[key] === item);
        if (alreadyMatchedLeft) {
            delete matches[alreadyMatchedLeft];
            const leftEl = leftColumn.querySelector(`[data-item="${alreadyMatchedLeft}"]`);
            if (leftEl) {
                leftEl.classList.remove('matched');
                leftEl.style.background = '';
                const btn = leftEl.querySelector('.matching-cancel-btn');
                if (btn) leftEl.removeChild(btn);
            }
        }
        matches[selectedLeft] = item;
        currentTest.answers[currentTest.currentQuestion] = { ...matches };
        // تحديث الواجهة
        const leftEl = leftColumn.querySelector(`[data-item="${selectedLeft}"]`);
        if (leftEl) {
            leftEl.classList.add('matched');
            leftEl.classList.remove('selected');
            if (!pairColors[selectedLeft]) {
                pairColors[selectedLeft] = colorList[colorIdx % colorList.length];
                colorIdx++;
            }
            leftEl.style.background = pairColors[selectedLeft];
            // أضف زر الإلغاء إذا لم يكن موجودًا
            if (!leftEl.querySelector('.matching-cancel-btn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = '✖';
                cancelBtn.title = 'إلغاء التوصيلة';
                cancelBtn.className = 'matching-cancel-btn';
                cancelBtn.onclick = function(e) {
                    e.stopPropagation();
                    delete matches[selectedLeft];
                    currentTest.answers[currentTest.currentQuestion] = { ...matches };
                    leftEl.classList.remove('matched');
                    leftEl.style.background = '';
                    const rightEl = rightColumn.querySelector(`[data-item="${item}"]`);
                    if (rightEl) {
                        rightEl.classList.remove('matched');
                        rightEl.style.background = '';
                        const btn = rightEl.querySelector('.matching-cancel-btn');
                        if (btn) rightEl.removeChild(btn);
                    }
                    if (leftEl.querySelector('.matching-cancel-btn')) leftEl.removeChild(cancelBtn);
                };
                leftEl.appendChild(cancelBtn);
            }
        }
        rightItem.classList.add('matched');
        rightItem.style.background = pairColors[selectedLeft];
        // أضف زر الإلغاء إذا لم يكن موجودًا
        if (!rightItem.querySelector('.matching-cancel-btn')) {
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '✖';
            cancelBtn.title = 'إلغاء التوصيلة';
            cancelBtn.className = 'matching-cancel-btn';
            cancelBtn.onclick = function(e) {
                e.stopPropagation();
                delete matches[selectedLeft];
                currentTest.answers[currentTest.currentQuestion] = { ...matches };
                rightItem.classList.remove('matched');
                rightItem.style.background = '';
                const leftEl = leftColumn.querySelector(`[data-item="${selectedLeft}"]`);
                if (leftEl) {
                    leftEl.classList.remove('matched');
                    leftEl.style.background = '';
                    const btn = leftEl.querySelector('.matching-cancel-btn');
                    if (btn) leftEl.removeChild(btn);
                }
                if (rightItem.querySelector('.matching-cancel-btn')) rightItem.removeChild(cancelBtn);
            };
            rightItem.appendChild(cancelBtn);
        }
        selectedLeft = null;
        showAnswerNote();
    });

    rightColumn.appendChild(rightItem);
});

            columnsDiv.appendChild(leftColumn);
            columnsDiv.appendChild(rightColumn);

            matchingDiv.appendChild(instruction);
            matchingDiv.appendChild(columnsDiv);
            container.appendChild(matchingDiv);
        }

        function displayOrdering(q, container) {
            const orderingDiv = document.createElement('div');
            orderingDiv.className = 'ordering-container';

            const instruction = document.createElement('p');
            instruction.textContent = 'اسحب العناصر لترتيبها بالتسلسل الصحيح';
            instruction.style.marginBottom = '20px';
            instruction.style.fontWeight = '600';
            instruction.style.textAlign = 'center';

            const itemsContainer = document.createElement('div');
            itemsContainer.className = 'ordering-items';

            const pinnedItem = Array.isArray(q.correctOrder) && q.correctOrder.length > 0
                ? q.correctOrder[0]
                : null;

            const savedAnswer = currentTest.answers[currentTest.currentQuestion];
            let itemsToShow;

            if (savedAnswer && Array.isArray(savedAnswer)) {
                const sanitizedAnswer = pinnedItem
                    ? savedAnswer.filter(item => item !== pinnedItem)
                    : [...savedAnswer];
                itemsToShow = pinnedItem ? [pinnedItem, ...sanitizedAnswer] : sanitizedAnswer;
            } else {
                const shuffledItems = q.items.slice().sort(() => Math.random() - 0.5);
                if (pinnedItem) {
                    const withoutPinned = shuffledItems.filter(item => item !== pinnedItem);
                    itemsToShow = [pinnedItem, ...withoutPinned];
                } else {
                    itemsToShow = shuffledItems;
                }
            }

            function updateOrderingNumbers() {
                const items = itemsContainer.querySelectorAll('.ordering-item');
                items.forEach((item, index) => {
                    const numberSpan = item.querySelector('.ordering-number');
                    numberSpan.textContent = index + 1;
                });
            }

            itemsToShow.forEach((item, index) => {
                const orderingItem = document.createElement('div');
                orderingItem.className = 'ordering-item';
                orderingItem.dataset.item = item;

                const isPinned = pinnedItem && item === pinnedItem;
                if (!isPinned) {
                    orderingItem.draggable = true;
                } else {
                    orderingItem.classList.add('fixed-ordering-item');
                    orderingItem.draggable = false;
                }

                const itemText = document.createElement('span');
                itemText.textContent = item;

                const numberSpan = document.createElement('span');
                numberSpan.className = 'ordering-number';
                numberSpan.textContent = index + 1;

                orderingItem.appendChild(itemText);
                orderingItem.appendChild(numberSpan);

                if (!isPinned) {
                    orderingItem.addEventListener('dragstart', function(e) {
                        this.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', item);
                    });

                    orderingItem.addEventListener('dragend', function() {
                        this.classList.remove('dragging');
                    });
                }

                itemsContainer.appendChild(orderingItem);
            });

            itemsContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                const dragging = document.querySelector('.ordering-item.dragging');
                if (!dragging) return;
                const afterElement = getDragAfterElement(itemsContainer, e.clientY);
                const fixedElement = itemsContainer.querySelector('.fixed-ordering-item');
                let targetElement = afterElement;

                if (fixedElement && targetElement === fixedElement) {
                    targetElement = fixedElement.nextElementSibling;
                }
                
                if (targetElement == null) {
                    itemsContainer.appendChild(dragging);
                } else {
                    itemsContainer.insertBefore(dragging, targetElement);
                }
                
                updateOrderingNumbers();
                updateOrderingAnswer();
            });

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.ordering-item:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            function updateOrderingAnswer() {
                const orderedItems = Array.from(itemsContainer.children).map(el => el.dataset.item);
                if (pinnedItem) {
                    const filtered = orderedItems.filter(item => item !== pinnedItem);
                    currentTest.answers[currentTest.currentQuestion] = [pinnedItem, ...filtered];
                } else {
                    currentTest.answers[currentTest.currentQuestion] = orderedItems;
                }
                showAnswerNote();
            }

            updateOrderingNumbers();

            orderingDiv.appendChild(instruction);
            orderingDiv.appendChild(itemsContainer);
            container.appendChild(orderingDiv);
        }

        function displayMultipleSelect(q, container) {
            const multiSelectDiv = document.createElement('div');
            multiSelectDiv.className = 'multiple-select-container';

            const instructions = document.createElement('div');
            instructions.className = 'multiple-select-instructions';
            instructions.textContent = 'اختر كل ما ينطبق';

            const savedAnswer = currentTest.answers[currentTest.currentQuestion];
            let selectedOptions = [];
            if (savedAnswer && Array.isArray(savedAnswer)) {
                selectedOptions = [...savedAnswer];
            }

            q.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'multiple-select-option';
                
                if (selectedOptions.includes(index)) {
                    optionDiv.classList.add('selected');
                }

                const checkbox = document.createElement('div');
                checkbox.className = 'multiple-select-checkbox';
                if (selectedOptions.includes(index)) {
                    checkbox.textContent = '✓';
                }

                const text = document.createElement('span');
                text.textContent = option;

                optionDiv.appendChild(checkbox);
                optionDiv.appendChild(text);

                optionDiv.addEventListener('click', function() {
                    const isSelected = this.classList.contains('selected');
                    
                    if (isSelected) {
                        this.classList.remove('selected');
                        checkbox.textContent = '';
                        selectedOptions = selectedOptions.filter(i => i !== index);
                    } else {
                        this.classList.add('selected');
                        checkbox.textContent = '✓';
                        selectedOptions.push(index);
                    }

                    currentTest.answers[currentTest.currentQuestion] = selectedOptions;
                    if (selectedOptions.length > 0) {
                        showAnswerNote();
                    }
                });

                multiSelectDiv.appendChild(optionDiv);
            });

            container.appendChild(instructions);
            container.appendChild(multiSelectDiv);
        }

        function showAnswerNote() {
            const note = document.getElementById('answerNote');
            note.style.display = 'block';
            setTimeout(() => {
                note.style.display = 'none';
            }, 2000);
        }

        document.getElementById('prevBtn').addEventListener('click', function() {
            if (currentTest.currentQuestion > 0) {
                currentTest.currentQuestion--;
                displayQuestion();
            }
        });

        document.getElementById('nextBtn').addEventListener('click', function() {
            if (currentTest.currentQuestion < currentTest.questions.length - 1) {
                currentTest.currentQuestion++;
                displayQuestion();
            }
        });

        document.getElementById('saveProgressBtn').addEventListener('click', function() {
            if (currentTest.timerInterval) {
                clearInterval(currentTest.timerInterval);
            }
            alert('تم حفظ تقدمك! يمكنك العودة لاحقاً لإكمال الاختبار.');
            navigateTo('home');
        });

        document.getElementById('finishBtn').addEventListener('click', finishTest);

        function checkEssayAnswer(userAnswer, modelAnswer) {
            // تنظيف النصوص وتحويلها للأحرف الصغيرة
            const cleanUser = userAnswer.trim().toLowerCase()
                .replace(/[،؛:.!؟]/g, '') // إزالة علامات الترقيم
                .replace(/\s+/g, ' '); // توحيد المسافات
            
            const cleanModel = modelAnswer.trim().toLowerCase()
                .replace(/[،؛:.!؟]/g, '')
                .replace(/\s+/g, ' ');

            // استخراج الكلمات المفتاحية من الإجابة النموذجية
            const modelWords = cleanModel.split(' ').filter(word => word.length > 2);
            const userWords = cleanUser.split(' ');

            // حساب نسبة التطابق
            let matchCount = 0;
            modelWords.forEach(modelWord => {
                if (userWords.some(userWord => 
                    userWord.includes(modelWord) || modelWord.includes(userWord) ||
                    Math.abs(userWord.length - modelWord.length) <= 1
                )) {
                    matchCount++;
                }
            });

            // إذا كانت نسبة التطابق أكثر من 40% نعتبر الإجابة صحيحة
            const matchPercentage = (matchCount / modelWords.length) * 100;
            return matchPercentage >= 40;
        }

        function formatDurationDisplay(seconds) {
            if (!Number.isFinite(seconds)) {
                return '0 د 0 ث';
            }
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes} د ${remainingSeconds} ث`;
        }

        function formatDurationEmail(seconds) {
            if (!Number.isFinite(seconds)) {
                return 'غير محسوب';
            }
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes} دقيقة ${remainingSeconds} ثانية`;
        }

        function buildResultSummary() {
            const lines = [
                `اسم الطالب: ${currentTest.studentName || 'غير محدد'}`,
                `المادة: ${currentTest.subject || 'غير محددة'}`,
                `المستوى: ${currentTest.level || 'غير محدد'}`,
                `النتيجة: ${typeof currentTest.scorePercentage === 'number' ? currentTest.scorePercentage + '%' : 'غير متوفرة'}`,
                `عدد الإجابات الصحيحة: ${currentTest.correctCount}`,
                `عدد الإجابات الخاطئة: ${currentTest.incorrectCount}`,
                `الوقت المستغرق: ${formatDurationEmail(currentTest.timeSpentSeconds)}`,
                '',
                `تاريخ الإنشاء: ${new Date().toLocaleString('ar-EG')}`,
                '',
                'تم إنشاء هذه النتيجة بواسطة منصة الاختبارات التعليمية.'
            ];

            return lines.join('\n');
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        async function finishTest() {
            if (currentTest.timerInterval) {
                clearInterval(currentTest.timerInterval);
            }

            const timeSpent = Math.floor((Date.now() - currentTest.startTime) / 1000);
            let correctCount = 0;

            currentTest.questions.forEach((q, index) => {
                const userAnswer = currentTest.answers[index];
                const questionType = q.type || 'multiple_choice';

                if (questionType === 'multiple_choice') {
                    if (userAnswer === q.correct) {
                        correctCount++;
                    }
                } else if (questionType === 'drag_drop') {
                    if (Array.isArray(userAnswer) && JSON.stringify(userAnswer) === JSON.stringify(q.correctOrder)) {
                        correctCount++;
                    }
                } else if (questionType === 'dropdown') {
                    if (userAnswer === q.correct) {
                        correctCount++;
                    }
                } else if (questionType === 'click_drag') {
                    if (userAnswer === q.correct) {
                        correctCount++;
                    }
                } else if (questionType === 'essay') {
                    // للأسئلة المقالية، نقارن مع الإجابة النموذجية
                    if (userAnswer && typeof userAnswer === 'string' && q.modelAnswer) {
                        if (checkEssayAnswer(userAnswer, q.modelAnswer)) {
                            correctCount++;
                        }
                    }
                } else if (questionType === 'matching') {
                    if (userAnswer && typeof userAnswer === 'object') {
                        let allCorrect = true;
                        for (const [key, value] of Object.entries(q.correctMatches)) {
                            if (userAnswer[key] !== value) {
                                allCorrect = false;
                                break;
                            }
                        }
                        if (allCorrect && Object.keys(userAnswer).length === Object.keys(q.correctMatches).length) {
                            correctCount++;
                        }
                    }
                } else if (questionType === 'ordering') {
                    if (Array.isArray(userAnswer) && JSON.stringify(userAnswer) === JSON.stringify(q.correctOrder)) {
                        correctCount++;
                    }
                } else if (questionType === 'multiple_select') {
                    if (Array.isArray(userAnswer) && Array.isArray(q.correct)) {
                        const sortedUser = [...userAnswer].sort((a, b) => a - b);
                        const sortedCorrect = [...q.correct].sort((a, b) => a - b);
                        if (JSON.stringify(sortedUser) === JSON.stringify(sortedCorrect)) {
                            correctCount++;
                        }
                    }
                }
            });

            const totalQuestions = currentTest.questions.length;
            const score = (correctCount / totalQuestions) * 100;

            currentTest.scorePercentage = Math.round(score);
            currentTest.correctCount = correctCount;
            currentTest.incorrectCount = totalQuestions - correctCount;
            currentTest.timeSpentSeconds = timeSpent;

            document.getElementById('scorePercentage').textContent = `${currentTest.scorePercentage}%`;
            document.getElementById('correctCount').textContent = currentTest.correctCount;
            document.getElementById('incorrectCount').textContent = currentTest.incorrectCount;
            document.getElementById('timeSpent').textContent = formatDurationDisplay(currentTest.timeSpentSeconds);

            displayReview();
            navigateTo('results');
        }

        function displayReview() {
            const reviewContainer = document.getElementById('reviewContainer');
            reviewContainer.innerHTML = '';

            currentTest.questions.forEach((q, index) => {
                const reviewItem = document.createElement('div');
                reviewItem.className = 'review-item';

                const questionDiv = document.createElement('div');
                questionDiv.className = 'review-question';
                questionDiv.innerHTML = `<strong>السؤال ${index + 1}:</strong> ${q.q}`;
                reviewItem.appendChild(questionDiv);

                const userAnswer = currentTest.answers[index];
                const userAnswerDiv = document.createElement('div');
                userAnswerDiv.className = 'review-answer user-answer';
                
                const correctAnswerDiv = document.createElement('div');
                correctAnswerDiv.className = 'review-answer correct-answer';

                let isCorrect = false;
                const questionType = q.type || 'multiple_choice';

                if (questionType === 'multiple_choice') {
                    isCorrect = userAnswer === q.correct;
                    userAnswerDiv.textContent = `إجابتك: ${userAnswer !== null ? q.options[userAnswer] : 'لم تجب'}`;
                    correctAnswerDiv.textContent = `الإجابة الصحيحة: ${q.options[q.correct]}`;
                } else if (questionType === 'drag_drop' || questionType === 'ordering') {
                    isCorrect = Array.isArray(userAnswer) && JSON.stringify(userAnswer) === JSON.stringify(q.correctOrder);
                    userAnswerDiv.textContent = `ترتيبك: ${userAnswer ? userAnswer.join(', ') : 'لم تجب'}`;
                    correctAnswerDiv.textContent = `الترتيب الصحيح: ${q.correctOrder.join(', ')}`;
                } else if (questionType === 'dropdown') {
                    isCorrect = userAnswer === q.correct;
                    userAnswerDiv.textContent = `اختيارك: ${userAnswer !== null ? q.options[userAnswer] : 'لم تجب'}`;
                    correctAnswerDiv.textContent = `الاختيار الصحيح: ${q.options[q.correct]}`;
                } else if (questionType === 'click_drag') {
                    isCorrect = userAnswer === q.correct;
                    userAnswerDiv.textContent = `اختيارك: ${userAnswer !== null ? userAnswer : 'لم تجب'}`;
                    correctAnswerDiv.textContent = `الاختيار الصحيح: ${q.correct}`;
                } else if (questionType === 'essay') {
                    isCorrect = userAnswer && typeof userAnswer === 'string' && q.modelAnswer && checkEssayAnswer(userAnswer, q.modelAnswer);
                    userAnswerDiv.innerHTML = `إجابتك: <p style="white-space: pre-wrap; background: #f0f0f0; padding: 10px; border-radius: 4px;">${userAnswer || 'لم تجب'}</p>`;
                    correctAnswerDiv.innerHTML = `الإجابة النموذجية: <p style="white-space: pre-wrap; background: #e8f5e9; padding: 10px; border-radius: 4px;">${q.modelAnswer}</p>`;
                } else if (questionType === 'matching') {
                    if (userAnswer && typeof userAnswer === 'object') {
                        let allCorrect = true;
                        for (const [key, value] of Object.entries(q.correctMatches)) {
                            if (userAnswer[key] !== value) {
                                allCorrect = false;
                                break;
                            }
                        }
                        isCorrect = allCorrect && Object.keys(userAnswer).length === Object.keys(q.correctMatches).length;
                    }
                    
                    const userAnswerText = userAnswer ? Object.entries(userAnswer).map(([k, v]) => `${k} -> ${v}`).join('<br>') : 'لم تجب';
                    userAnswerDiv.innerHTML = `مطابقتك:<br>${userAnswerText}`;
                    
                    const correctAnswerText = Object.entries(q.correctMatches).map(([k, v]) => `${k} -> ${v}`).join('<br>');
                    correctAnswerDiv.innerHTML = `المطابقة الصحيحة:<br>${correctAnswerText}`;
                } else if (questionType === 'multiple_select') {
                    if (Array.isArray(userAnswer) && Array.isArray(q.correct)) {
                        const sortedUser = [...userAnswer].sort((a, b) => a - b);
                        const sortedCorrect = [...q.correct].sort((a, b) => a - b);
                        isCorrect = JSON.stringify(sortedUser) === JSON.stringify(sortedCorrect);
                    }
                    
                    const userAnswerText = userAnswer ? userAnswer.map(i => q.options[i]).join(', ') : 'لم تجب';
                    userAnswerDiv.textContent = `اختياراتك: ${userAnswerText}`;
                    
                    const correctAnswerText = q.correct.map(i => q.options[i]).join(', ');
                    correctAnswerDiv.textContent = `الاختيارات الصحيحة: ${correctAnswerText}`;
                }

                if (isCorrect) {
                    reviewItem.classList.add('correct');
                    reviewItem.appendChild(correctAnswerDiv);
                } else {
                    reviewItem.classList.add('incorrect');
                    reviewItem.appendChild(userAnswerDiv);
                    reviewItem.appendChild(correctAnswerDiv);
                }

                reviewContainer.appendChild(reviewItem);
            });
        }

        document.getElementById('newTestBtn').addEventListener('click', function() {
            // إعادة تعيين كل شيء
            currentTest = {
                subject: '',
                level: '',
                duration: 0,
                studentName: '',
                recipientEmail: defaultRecipient,
                questions: [],
                answers: [],
                currentQuestion: 0,
                startTime: null,
                timerInterval: null,
                scorePercentage: null,
                correctCount: 0,
                incorrectCount: 0,
                timeSpentSeconds: 0,
                remainingSeconds: 0,
                lastVisitedPage: 'home'
            };

            persistTestState();

            // إعادة تعيين حقول النموذج
            const studentNameInput = document.getElementById('studentName');
            const recipientEmailInput = document.getElementById('recipientEmail');
            const levelSelectEl = document.getElementById('levelSelect');
            const durationSelectEl = document.getElementById('durationSelect');
            const continueBtnEl = document.getElementById('continueBtn');

            if (studentNameInput) studentNameInput.value = '';
            if (recipientEmailInput) recipientEmailInput.value = defaultRecipient;
            if (levelSelectEl) levelSelectEl.value = '';
            if (durationSelectEl) durationSelectEl.value = '0';
            if (continueBtnEl) continueBtnEl.disabled = true;

            // تعيين المادة تلقائياً
            currentTest.subject = 'لغة عربية';

            navigateTo('home');
        });

        document.getElementById('sendResultBtn').addEventListener('click', function() {
            if (typeof currentTest.scorePercentage !== 'number') {
                alert('يرجى إكمال الاختبار أولاً قبل إرسال النتيجة.');
                return;
            }

            const email = defaultRecipient;

            const subject = encodeURIComponent(`نتيجة اختبار ${currentTest.studentName || 'طالب'}`);
            const body = encodeURIComponent(buildResultSummary());

            window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
        });

        // تحميل الإعدادات من data_sdk.js
        if (typeof window.getTestConfig === 'function') {
            window.getTestConfig().then(config => {
                currentConfig = { ...defaultConfig, ...config };
                updateUI();
            }).catch(error => {
                console.error("Failed to load config:", error);
                updateUI();
            });
        } else {
            updateUI();
        }

        // تحميل بيانات الاختبار من data_sdk.js
        if (typeof window.getTestData === 'function') {
            window.getTestData().then(data => {
                allTestData = data;
                // يمكنك هنا دمج بيانات الاختبار المحملة مع البيانات الموجودة
                // على سبيل المثال: Object.assign(questions, data);
            }).catch(error => {
                console.error("Failed to load test data:", error);
            });
        }
    
